<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEⅠ クイズ</title>
    <!-- PWA settings -->
    <!-- PWAの設定を定義するマニフェストファイルを読み込みます -->
    <link rel="manifest" href="manifest.json">
    <!-- iOSのホーム画面用アイコンと表示設定 -->
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="BEⅠ クイズ">
    <!-- PWAのテーマカラーを設定します（ダークモード対応） -->
    <meta name="theme-color" content="#f0f9ff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tone.js library for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Mode Default Colors */
            --bg-primary: #f0f9ff;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --button-bg-default: #f1f5f9;
            --button-text-default: #334155;
            --button-border-default: #cbd5e1;
            --nav-button-bg: #0ea5e9;
            --nav-button-hover-bg: #0284c7;
            --nav-button-shadow: rgba(14, 165, 233, 0.3);
            --start-button-bg: #10b981;
            --start-button-hover-bg: #059669;
            --start-button-shadow: rgba(16, 185, 129, 0.3);
            --interrupt-button-bg: #ef4444;
            --interrupt-button-hover-bg: #dc2626;
            --interrupt-button-shadow: rgba(239, 68, 68, 0.3);
            --progress-bar-bg: #0ea5e9;
            --feedback-bg: #f8fafc;
            --feedback-border: #e2e8f0;
            --correct-feedback-text: #15803d;
            --correct-feedback-border: #22c55e;
            --incorrect-feedback-text: #b91c1c;
            --incorrect-feedback-border: #ef4444;
            --correct-option-bg: #dcfce7;
            --incorrect-option-bg: #fee2e2;
            --score-color: #0c4a6e;
            --score-comment-color: #0369a1;
            --settings-button-bg: #6366f1;
            --settings-button-hover-bg: #4f46e5;
            --settings-button-shadow: rgba(99, 102, 241, 0.3);
            --themed-text-color: #0c4a6e;
            --highlight-bg: #fef9c3;
            --highlight-text: #713f12;
            
            /* Themed Background Colors */
            --bg-primary-default: #f0f9ff;
            --bg-primary-red: #fff1f2;
            --bg-primary-green: #f0fdf4;
            --bg-primary-indigo: #f5f3ff;
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --button-bg-default: #334155;
            --button-text-default: #e2e8f0;
            --button-border-default: #475569;
            --nav-button-bg: #38bdf8;
            --nav-button-hover-bg: #0ea5e9;
            --nav-button-shadow: rgba(56, 189, 248, 0.3);
            --start-button-bg: #2dd4bf;
            --start-button-hover-bg: #14b8a6;
            --start-button-shadow: rgba(45, 212, 191, 0.3);
            --interrupt-button-bg: #f87171;
            --interrupt-button-hover-bg: #ef4444;
            --interrupt-button-shadow: rgba(248, 113, 113, 0.3);
            --progress-bar-bg: #38bdf8;
            --feedback-bg: #334155;
            --feedback-border: #475569;
            --correct-feedback-text: #a7f3d0;
            --correct-feedback-border: #4ade80;
            --incorrect-feedback-text: #fecaca;
            --incorrect-feedback-border: #f87171;
            --correct-option-bg: #14532d;
            --incorrect-option-bg: #7f1d1d;
            --score-color: #e0f2fe;
            --score-comment-color: #7dd3fc;
            --settings-button-bg: #818cf8;
            --settings-button-hover-bg: #6366f1;
            --settings-button-shadow: rgba(129, 140, 248, 0.3);
            --themed-text-color: #e0f2fe;
            --highlight-bg: #422006;
            --highlight-text: #fef3c7;

            /* Themed Background Colors (Dark) */
            --bg-primary-default: #0f172a;
            --bg-primary-red: #261012;
            --bg-primary-green: #0d1f12;
            --bg-primary-indigo: #1a1b2d;
        }

        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        .container {
            background-color: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            padding: 25px;
            width: 100%;
            max-width: 700px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            z-index: 1;
            transition: background-color 0.3s ease;
        }
        .screen {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        .screen.active {
            display: flex;
        }
        .main-title {
            color: var(--themed-text-color);
            transition: color 0.3s ease;
        }
        .question-area {
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
            text-align: left;
        }
        .long-text-area {
            background-color: var(--feedback-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            text-align: left;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
        }
        .long-text-area .highlight {
            background-color: var(--highlight-bg);
            color: var(--highlight-text);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        .question-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--themed-text-color);
            margin-bottom: 10px;
            transition: color 0.3s ease;
            width: 100%;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        .option-button {
            background-color: var(--button-bg-default);
            color: var(--button-text-default);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--button-border-default);
            text-align: left;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            line-height: 1.5;
        }
        .option-button:hover {
            background-color: var(--button-border-default);
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }
        .option-button.correct {
            background-color: var(--correct-option-bg);
            border-color: var(--correct-feedback-border);
            color: var(--correct-feedback-text);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
        }
        .option-button.incorrect {
            background-color: var(--incorrect-option-bg);
            border-color: var(--incorrect-feedback-border);
            color: var(--incorrect-feedback-text);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }
        .navigation-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap; /* nowrap から wrap に変更 */
            gap: 10px;
        }
        .nav-button {
            background-color: var(--nav-button-bg);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px var(--nav-button-shadow);
            border: none;
        }
        .nav-button:hover {
            background-color: var(--nav-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 7px 20px var(--nav-button-shadow);
        }
        .nav-button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
        .feedback-message {
            margin-top: 10px;
            font-size: 1rem;
            font-weight: 600;
            text-align: left;
            padding: 10px 15px;
            border-radius: 12px;
            background-color: var(--feedback-bg);
            border: 1px solid var(--feedback-border);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        .feedback-message.correct-feedback {
            color: var(--correct-feedback-text);
            border-color: var(--correct-feedback-border);
        }
        .feedback-message.incorrect-feedback {
            color: var(--incorrect-feedback-text);
            border-color: var(--incorrect-feedback-border);
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            min-height: 24px;
            flex-wrap: wrap; /* nowrap から wrap に変更 */
        }
        .feedback-result {
            flex-grow: 1;
        }
        .feedback-result strong {
            font-size: 1.1rem;
        }
        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, margin-top 0.4s ease-out;
            padding-top: 0;
            margin-top: 0;
        }
        .explanation-content.show {
            max-height: 200px;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid var(--feedback-border);
        }
        .explanation-text {
            font-weight: 400;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }
        .feedback-message.correct-feedback .explanation-text {
            color: var(--correct-feedback-text);
        }
        .feedback-message.incorrect-feedback .explanation-text {
            color: var(--incorrect-feedback-text);
        }
        .toggle-explanation-button {
            background-color: var(--nav-button-bg);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px var(--nav-button-shadow);
            flex-shrink: 0;
        }
        .toggle-explanation-button:hover {
            transform: translateY(-1px);
        }
        .toggle-explanation-button.hidden {
            display: none;
        }
        .score-area {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--score-color);
            margin-top: 25px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            transition: color 0.3s ease;
        }
        .score-comment {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--score-comment-color);
            margin-top: 10px;
            transition: color 0.3s ease;
        }
        .mode-selection-dropdown, .question-count-selection {
            margin-bottom: 15px;
        }
        .mode-selection-dropdown label, .question-count-selection label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .mode-selection-dropdown select, .question-count-selection select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--button-border-default);
            font-size: 1rem;
            background-color: var(--button-bg-default);
            color: var(--button-text-default);
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%23333%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1.2em;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .start-button {
            background-color: var(--start-button-bg);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px var(--start-button-shadow);
            margin-top: 20px;
            border: none;
        }
        .start-button:hover {
            background-color: var(--start-button-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--start-button-shadow);
        }
        #settingsButton {
            background-color: var(--settings-button-bg);
            box-shadow: 0 5px 15px var(--settings-button-shadow);
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 35px; border-radius: 20px; text-align: center; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); max-width: 450px; width: 90%; transform: translateY(-30px); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0); }
        .modal-title { font-size: 2rem; font-weight: 800; color: var(--score-color); margin-bottom: 20px; transition: color 0.3s ease; }
        .modal-message { font-size: 1.2rem; color: var(--text-primary); margin-bottom: 30px; line-height: 1.6; transition: color 0.3s ease; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-button { background-color: var(--nav-button-bg); color: white; padding: 12px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; box-shadow: 0 4px 10px var(--nav-button-shadow); border: none; }
        .modal-button:hover { background-color: var(--nav-button-hover-bg); transform: translateY(-1px); }
        #modalCancelButton { background-color: #64748b; box-shadow: 0 4px 10px rgba(100, 116, 139, 0.3); }
        #modalCancelButton:hover { background-color: #475569; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 10px; height: 15px; margin-top: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; background-color: var(--progress-bar-bg); border-radius: 10px; transition: width 0.3s ease-in-out, background-color 0.3s ease; }
        .progress-text { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 10px; transition: color 0.3s ease; }
        .quiz-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1.5rem;
            padding-bottom: 0.5rem;
            gap: 1rem;
        }
        .quiz-header .main-title {
            flex-grow: 1;
            text-align: center;
            font-size: 1.5rem;
            margin: 0;
            padding: 0 4rem; /* Add padding to avoid overlap */
        }
        #interruptButton {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            padding: 8px 15px;
            font-size: 0.8rem;
        }
        
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f06; opacity: 1; }
        
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--button-border-default); flex-wrap: nowrap; gap: 1rem;}
        .settings-option:last-child { border-bottom: none; }
        .settings-option-label { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; min-width: 0; }
        .settings-option-label label { font-size: 1.1rem; color: var(--text-primary); font-weight: 600; }
        .settings-option-label p { font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0 0 0; text-align: left; }
        .theme-colors { display: flex; gap: 10px; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; }
        .color-circle.selected { border-color: var(--nav-button-bg); }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; margin-left: auto; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--nav-button-bg); }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (min-width: 640px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
            .quiz-header .main-title {
                font-size: 1.875rem; /* text-3xl */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="confettiContainer" class="confetti-container"></div>

        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <h1 class="text-3xl font-bold mb-6 main-title">BEⅠ クイズ</h1>
            <p class="text-lg mb-4" style="color: var(--text-primary);">学習したいモードを選択してください。</p>
            <div class="mode-selection-dropdown">
                <select id="quizModeSelect">
                    <option value="random">全範囲からランダム出題</option>
                    <option value="incorrect">苦手克服モード</option>
                    <optgroup label="Lesson 1">
                        <option value="l1-target">TODAY's TARGET TEST</option>
                        <option value="l1-review">Review Quiz</option>
                    </optgroup>
                </select>
            </div>
            <button id="startButton" class="start-button">クイズ開始</button>
            <button id="settingsButton" class="nav-button">設定</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen">
            <div class="quiz-header">
                <h1 class="main-title font-bold">BEⅠ クイズ</h1>
                <button id="interruptButton" class="nav-button">中断</button>
            </div>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText" class="progress-text"></div>

            <div class="question-area">
                <div id="longTextArea" class="long-text-area" style="display: none;"></div>
                <div id="questionText" class="question-text"></div>
            </div>

            <div id="optionsGrid" class="options-grid"></div>

            <div id="feedbackMessage" class="feedback-message" style="display: none;">
                <div class="feedback-header">
                    <div id="feedbackResult"></div>
                    <button id="toggleExplanationButton" class="toggle-explanation-button hidden">解説▼</button>
                </div>
                <div id="explanationContent" class="explanation-content">
                    <div class="explanation-text"></div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button id="nextButton" class="nav-button">次の問題</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen">
            <h1 class="text-3xl font-bold mb-6 main-title">BEⅠ クイズ</h1>
            <h2 class="text-2xl font-bold mb-4" style="color: var(--score-color);">クイズ結果</h2>
            <div id="finalScore" class="score-area"></div>
            <div id="scoreComment" class="score-comment"></div>
            <button id="restartButton" class="nav-button mt-6">もう一度プレイ</button>
            <button id="redoIncorrectButton" class="nav-button mt-2" style="background-color: var(--interrupt-button-bg);">間違えた問題をもう一度やる</button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <h1 class="text-3xl font-bold mb-6 main-title">BEⅠ クイズ</h1>
            <h2 class="text-2xl font-bold mb-4 main-title">設定</h2>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="darkModeToggle">ダークモード</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label>テーマカラー</label>
                </div>
                <div class="theme-colors">
                    <div class="color-circle" data-theme="default" style="background-color: #0ea5e9;"></div>
                    <div class="color-circle" data-theme="red" style="background-color: #ef4444;"></div>
                    <div class="color-circle" data-theme="green" style="background-color: #10b981;"></div>
                    <div class="color-circle" data-theme="indigo" style="background-color: #6366f1;"></div>
                </div>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="questionCountSelect">問題数</label>
                </div>
                <select id="questionCountSelect">
                    <option value="5">5問</option>
                    <option value="10">10問</option>
                    <option value="15">15問</option>
                    <option value="20">20問</option>
                </select>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="showProgressToggle">進捗状況を表示</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="showProgressToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="enableSoundToggle">効果音</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="enableSoundToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="masteryModeToggle">習得モード</label>
                    <p>すべての問題は2回連続で正解するまで「習得済み」になりません。</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="masteryModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="backToStartButton" class="nav-button mt-6">戻る</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="modal-title"></h2>
            <p id="modalMessage" class="modal-message"></p>
            <div class="modal-buttons">
                <button id="modalConfirmButton" class="modal-button">はい</button>
                <button id="modalCancelButton" class="modal-button">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- PWA Service Worker Registration -->
    <script>
        // PWAのService Workerを登録します。これによりオフラインキャッシュなどが有効になります。
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker 登録成功:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker 登録失敗:', error);
                    });
            });
        }
    </script>
    <script>
        // --- App Specific ID ---
        const APP_PREFIX = 'BE1_QUIZ_V2_'; // Changed to V2 to reset storage

        // --- Question Data (Lesson 1 Only) ---
        const allQuestions = [
            // Lesson 1: TODAY's TARGET TEST
{ id: 'l1-t-1', lesson: 'l1-target', text: "As soon as the Claudia 5.0 was launched, it became the most ___ software that the company had ever released.", options: ["profit", "profitable", "profitably", "profits"], answer: "profitable", explanation: "名詞 'software' を説明するために形容詞 'profitable' が必要です。" },
{ id: 'l1-t-2', lesson: 'l1-target', text: "The tennis player said the biggest ___ of her professional career was becoming the world champion three times in a row.", options: ["achievable", "achieve", "achievement", "achiever"], answer: "achievement", explanation: "文の主語として名詞 'achievement' が必要です。" },
{ id: 'l1-t-3', lesson: 'l1-target', text: "This browser ___ updates itself whenever it detects that a new version of the browser is available.", options: ["automate", "automatic", "automatically", "automation"], answer: "automatically", explanation: "ブラウザがどのように更新されるかを説明するために副詞 'automatically' が必要です。" },
{ id: 'l1-t-4', lesson: 'l1-target', text: "Jim Coogan panicked a little when his boss told him to ___ the sales report by tomorrow morning.", options: ["final", "finale", "finalize", "finally"], answer: "finalize", explanation: "上司からの指示を完了するために動詞 'finalize' が必要です。" },
{ id: 'l1-t-5', lesson: 'l1-target', text: "We are sorry to tell you that the item you ordered is backordered and will not be ___ until the middle of May.", options: ["avail", "availability", "available", "availably"], answer: "available", explanation: "品物の状態を説明するために形容詞 'available' が必要です。" },
{ id: 'l1-t-6', lesson: 'l1-target', text: "The wife was really excited to hear about her husband's ___ to marketing manager.", options: ["promote", "promoter", "promotion", "promotional"], answer: "promotion", explanation: "新しい役職に昇進する出来事を説明するために名詞 'promotion' が必要です。" },
{ id: 'l1-t-7', lesson: 'l1-target', text: "The grocery store is known for selling only vegetables and fruits that are ___ grown or produced.", options: ["local", "localization", "localize", "locally"], answer: "locally", explanation: "野菜や果物がどのように栽培されているかを説明するために副詞 'locally' が必要です。" },
{ id: 'l1-t-8', lesson: 'l1-target', text: "Keiko Manning, an ___ candidate, won the election with more than 50 percent of the vote.", options: ["independence", "independency", "independent", "independently"], answer: "independent", explanation: "名詞 'candidate' を説明するために形容詞 'independent' が必要です。" },
{ id: 'l1-t-9', lesson: 'l1-target', text: "According to recent surveys, online education's accessibility and ___ are attracting millions of people to enroll.", options: ["afford", "affordability", "affordable", "affording"], answer: "affordability", explanation: "「accessibility」と並列になる名詞 'affordability' が必要です。" },
{ id: 'l1-t-10', lesson: 'l1-target', text: "The boss told Kim Lee that she was not chosen as the team leader ___ because of lack of experience, not because of her gender.", options: ["simple", "simplicity", "simplify", "simply"], answer: "simply", explanation: "ここでは「単に」「ただ」という意味で副詞 'simply' が使われています。" },
{ id: 'l1-t-11', lesson: 'l1-target', text: "Ken Boyd, the Chairperson of Medicom, Inc., will give his first lecture tonight on 'How to instantly ___ potential customers.'", options: ["attract", "attraction", "attractive", "attractively"], answer: "attract", explanation: "不定詞を形成するために 'to' の後に動詞 'attract' が必要です。" },
{ id: 'l1-t-12', lesson: 'l1-target', text: "The salesperson recommended the bamboo flooring to the client because it is ___ and inexpensive.", options: ["durability", "durable", "durables", "durably"], answer: "durable", explanation: "「inexpensive」と並列で床材を説明するために形容詞 'durable' が必要です。" },
{ id: 'l1-t-13', lesson: 'l1-target', text: "The results shows that the ___ of second-hand smoke on children is worse than expected.", options: ["effect", "effective", "effectively", "effects"], answer: "effects", explanation: "煙の複数の影響を指すため、複数形の名詞 'effects' が必要です。" },
{ id: 'l1-t-14', lesson: 'l1-target', text: "The following study is about how water flows and ___ freely between the rocks in a stream.", options: ["smooth", "smoothen", "smoothly", "smoothness"], answer: "smoothly", explanation: "水がどのように流れるかを説明するために副詞 'smoothly' が必要です。" },
{ id: 'l1-t-15', lesson: 'l1-target', text: "It would be greatly ___ if you could send me the latest catalogue of your products.", options: ["appreciate", "appreciated", "appreciation", "appreciatively"], answer: "appreciated", explanation: "ここでは受動態の構造で過去分詞 'appreciated' が使われています。" },
{ id: 'l1-t-16', lesson: 'l1-target', text: "Sam Kelly was shocked to receive the news that numerous ___ had been made with his credit card without his knowledge.", options: ["purchasable", "purchase", "purchaser", "purchases"], answer: "purchases", explanation: "「numerous」に合わせて複数形の名詞 'purchases' が必要です。" },

            // Lesson 1: Review Quiz
{ id: 'l1-r-1', lesson: 'l1-review', text: "It is expected that Zin Motors will make an ___ about the merger with DCI Autos today.", options: ["announce", "announced", "announcement", "announcer"], answer: "announcement", explanation: "「make an」の後に名詞 'announcement' が必要です。" },
{ id: 'l1-r-2', lesson: 'l1-review', text: "The market analyst was accused of passing ___ information to a trader at an investment firm today.", options: ["confidential", "confidentialities", "confidentiality", "confidentially"], answer: "confidential", explanation: "「information」を説明するために形容詞 'confidential' が必要です。" },
{ id: 'l1-r-3', lesson: 'l1-review', text: "Going against public opinion, the congress approved the new tax act by a ___ vote of 400 to 15.", options: ["overwhelm", "overwhelmed", "overwhelming", "overwhelmingly"], answer: "overwhelming", explanation: "「vote」を説明するために形容詞 'overwhelming' が必要です。" },
{ id: 'l1-r-4', lesson: 'l1-review', text: "When he was asked to ___ a few of his favorite things about Everton, the governor couldn't give an immediate reply.", options: ["namable", "name", "namely", "names"], answer: "name", explanation: "ここでは「リストアップする」または「特定する」という意味の動詞 'name' が必要です。" },
{ id: 'l1-r-5', lesson: 'l1-review', text: "Local media reported that the young entrepreneur made a generous ___ to the community college he graduated from.", options: ["donate", "donated", "donation", "donator"], answer: "donation", explanation: "「made a generous」の後に名詞 'donation' が必要です。" },
{ id: 'l1-r-6', lesson: 'l1-review', text: "In the speech, the project leader commended his team for being efficient, reliable and highly ___.", options: ["organization", "organize", "organized", "organizer"], answer: "organized", explanation: "チームを説明するために形容詞 'organized' が必要で、「efficient」と「reliable」と並列になっています。" },
{ id: 'l1-r-7', lesson: 'l1-review', text: "The talk show host ___ apologized for making offensive remarks about the Prime Minister.", options: ["public", "publicity", "publicize", "publicly"], answer: "publicly", explanation: "彼がどのように謝罪したかを説明するために副詞 'publicly' が必要です。" },
{ id: 'l1-r-8', lesson: 'l1-review', text: "Liam Woods is well known as a social ___, best-selling author and radio talk-show host.", options: ["active", "actively", "activist", "activity"], answer: "activist", explanation: "「著者」や「司会者」と並列で人物を説明するために名詞 'activist' が必要です。" },
        ];

        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectQuestionIds = [];
        let correctlyAnsweredByLesson = {};
        let consecutiveCorrectCounts = {};
        let sessionIncorrectQuestionIds = [];
        let answeredQuestions = new Set();
        let currentMode = 'random';
        let questionCount = 10;
        let showProgress = true;
        let enableSound = true;
        let masteryMode = false;
        let confettiAnimationId;

        // --- Sound Effect Setup ---
        const sounds = {
            correct: new Tone.Synth({ volume: -12, oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
            incorrect: new Tone.FMSynth({ volume: -8, harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.1 } }).toDestination(),
            click: new Tone.Synth({ volume: -15, oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination(),
            fanfare: new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination(),
        };

        function playSound(type) {
            if (!enableSound || Tone.context.state !== 'running') return;
            const now = Tone.now();
            try {
                switch (type) {
                    case 'correct': sounds.correct.triggerAttackRelease("C5", "8n", now); break;
                    case 'incorrect': sounds.incorrect.triggerAttackRelease("A2", "8n", now); break;
                    case 'click': sounds.click.triggerAttackRelease("C6", "16n", now); break;
                    case 'fanfare':
                        const fanfareNotes = ["C5", "E5", "G5", "C6"];
                        fanfareNotes.forEach((note, i) => {
                            sounds.fanfare.triggerAttackRelease(note, "8n", now + i * 0.15);
                        });
                        break;
                }
            } catch (error) {
                console.error("Sound playback failed:", error);
            }
        }
        
        // --- DOM Elements ---
        const startScreen = document.getElementById('startScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultScreen = document.getElementById('resultScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const quizModeSelect = document.getElementById('quizModeSelect');
        const startButton = document.getElementById('startButton');
        const settingsButton = document.getElementById('settingsButton');
        const backToStartButton = document.getElementById('backToStartButton');
        const longTextArea = document.getElementById('longTextArea');
        const questionTextElement = document.getElementById('questionText');
        const optionsGridElement = document.getElementById('optionsGrid');
        const feedbackMessageElement = document.getElementById('feedbackMessage');
        const feedbackResultElement = document.getElementById('feedbackResult');
        const explanationContentElement = document.getElementById('explanationContent');
        const explanationTextElement = explanationContentElement.querySelector('.explanation-text');
        const toggleExplanationButton = document.getElementById('toggleExplanationButton');
        const nextButton = document.getElementById('nextButton');
        const interruptButton = document.getElementById('interruptButton');
        const progressBarContainer = document.querySelector('.progress-container');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const finalScore = document.getElementById('finalScore');
        const scoreComment = document.getElementById('scoreComment');
        const confettiContainer = document.getElementById('confettiContainer');
        const restartButton = document.getElementById('restartButton');
        const redoIncorrectButton = document.getElementById('redoIncorrectButton');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const themeColorCircles = document.querySelectorAll('.color-circle');
        const questionCountSelect = document.getElementById('questionCountSelect');
        const showProgressToggle = document.getElementById('showProgressToggle');
        const enableSoundToggle = document.getElementById('enableSoundToggle');
        const masteryModeToggle = document.getElementById('masteryModeToggle');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');

        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.add('show');
            modalConfirmButton.style.display = onConfirm ? 'inline-block' : 'none';
            modalCancelButton.textContent = onConfirm ? 'いいえ' : '閉じる';
            modalConfirmButton.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
            modalCancelButton.onclick = closeModal;
        }
        function closeModal() { modal.classList.remove('show'); }
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        const themes = {
            'default': { light: { '--nav-button-bg': '#0ea5e9', '--nav-button-hover-bg': '#0284c7', '--nav-button-shadow': 'rgba(14, 165, 233, 0.3)', '--progress-bar-bg': '#0ea5e9', '--bg-primary': 'var(--bg-primary-default)', '--themed-text-color': '#0c4a6e' } },
            'red': { light: { '--nav-button-bg': '#ef4444', '--nav-button-hover-bg': '#dc2626', '--nav-button-shadow': 'rgba(239, 68, 68, 0.3)', '--progress-bar-bg': '#ef4444', '--bg-primary': 'var(--bg-primary-red)', '--themed-text-color': '#991b1b' } },
            'green': { light: { '--nav-button-bg': '#10b981', '--nav-button-hover-bg': '#059669', '--nav-button-shadow': 'rgba(16, 185, 129, 0.3)', '--progress-bar-bg': '#10b981', '--bg-primary': 'var(--bg-primary-green)', '--themed-text-color': '#065f46' } },
            'indigo': { light: { '--nav-button-bg': '#6366f1', '--nav-button-hover-bg': '#4f46e5', '--nav-button-shadow': 'rgba(99, 102, 241, 0.3)', '--progress-bar-bg': '#6366f1', '--bg-primary': 'var(--bg-primary-indigo)', '--themed-text-color': '#4338ca' } }
        };
        
        const darkThemeOverrides = {
            'default': { '--bg-primary': 'var(--bg-primary-default)', '--themed-text-color': '#e0f2fe' },
            'red': { '--bg-primary': 'var(--bg-primary-red)', '--themed-text-color': '#fca5a5' },
            'green': { '--bg-primary': 'var(--bg-primary-green)', '--themed-text-color': '#a7f3d0' },
            'indigo': { '--bg-primary': 'var(--bg-primary-indigo)', '--themed-text-color': '#c7d2fe' }
        };

        function applyColors(themeName, isDark) {
            const root = document.documentElement;
            const defaultLightColors = { '--bg-secondary': '#ffffff', '--text-primary': '#1e293b', '--text-secondary': '#64748b', '--button-bg-default': '#f1f5f9', '--button-text-default': '#334155', '--button-border-default': '#cbd5e1', '--start-button-bg': '#10b981', '--start-button-hover-bg': '#059669', '--start-button-shadow': 'rgba(16, 185, 129, 0.3)', '--interrupt-button-bg': '#ef4444', '--interrupt-button-hover-bg': '#dc2626', '--interrupt-button-shadow': 'rgba(239, 68, 68, 0.3)', '--feedback-bg': '#f8fafc', '--feedback-border': '#e2e8f0', '--correct-feedback-text': '#15803d', '--correct-feedback-border': '#22c55e', '--incorrect-feedback-text': '#b91c1c', '--incorrect-feedback-border': '#ef4444', '--correct-option-bg': '#dcfce7', '--incorrect-option-bg': '#fee2e2', '--score-color': '#0c4a6e', '--score-comment-color': '#0369a1', '--settings-button-bg': '#6366f1', '--settings-button-hover-bg': '#4f46e5', '--settings-button-shadow': 'rgba(99, 102, 241, 0.3)' };
            const darkThemeColors = { '--bg-secondary': '#1e293b', '--text-primary': '#e2e8f0', '--text-secondary': '#94a3b8', '--button-bg-default': '#334155', '--button-text-default': '#e2e8f0', '--button-border-default': '#475569', '--nav-button-bg': '#38bdf8', '--nav-button-hover-bg': '#0ea5e9', '--nav-button-shadow': 'rgba(56, 189, 248, 0.3)', '--start-button-bg': '#2dd4bf', '--start-button-hover-bg': '#14b8a6', '--start-button-shadow': 'rgba(45, 212, 191, 0.3)', '--interrupt-button-bg': '#f87171', '--interrupt-button-hover-bg': '#ef4444', '--interrupt-button-shadow': 'rgba(248, 113, 113, 0.3)', '--progress-bar-bg': '#38bdf8', '--feedback-bg': '#334155', '--feedback-border': '#475569', '--correct-feedback-text': '#a7f3d0', '--correct-feedback-border': '#4ade80', '--incorrect-feedback-text': '#fecaca', '--incorrect-feedback-border': '#f87171', '--correct-option-bg': '#14532d', '--incorrect-option-bg': '#7f1d1d', '--score-color': '#e0f2fe', '--score-comment-color': '#7dd3fc', '--settings-button-bg': '#818cf8', '--settings-button-hover-bg': '#6366f1', '--settings-button-shadow': 'rgba(129, 140, 248, 0.3)' };
            
            if (isDark) {
                Object.entries(darkThemeColors).forEach(([prop, value]) => root.style.setProperty(prop, value));
                const themeOverrides = darkThemeOverrides[themeName] || darkThemeOverrides.default;
                Object.entries(themeOverrides).forEach(([prop, value]) => root.style.setProperty(prop, value));
            } else {
                Object.entries(defaultLightColors).forEach(([prop, value]) => root.style.setProperty(prop, value));
                const themeOverrides = themes[themeName]?.light || themes.default.light;
                Object.entries(themeOverrides).forEach(([prop, value]) => root.style.setProperty(prop, value));
            }
        }

        function setDarkMode(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem(APP_PREFIX + 'darkMode', isDark);
            applyColors(localStorage.getItem(APP_PREFIX + 'themeColor') || 'default', isDark);
        }

        function setThemeColor(themeName) {
            localStorage.setItem(APP_PREFIX + 'themeColor', themeName);
            applyColors(themeName, document.body.classList.contains('dark-mode'));
        }

        function switchScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenToShow.classList.add('active');
            window.scrollTo(0, 0);
        }

        async function prepareQuiz() {
            if (Tone.context.state !== 'running') await Tone.start();
            playSound('click');
            currentMode = quizModeSelect.value;
            localStorage.setItem(APP_PREFIX + 'lastSelectedMode', currentMode);
            questionCount = parseInt(questionCountSelect.value, 10);
            localStorage.setItem(APP_PREFIX + 'questionCount', questionCount);
            
            currentQuestions = [];
            answeredQuestions.clear();
            sessionIncorrectQuestionIds = [];
            score = 0;
            currentQuestionIndex = 0;

            let sourcePool = [];
            const isLessonMode = currentMode !== 'random' && currentMode !== 'incorrect';

            if (isLessonMode) {
                const allLessonQuestions = allQuestions.filter(q => q.lesson === currentMode);
                const correctlyAnsweredIds = correctlyAnsweredByLesson[currentMode] || [];
                
                if (allLessonQuestions.length > 0 && correctlyAnsweredIds.length >= allLessonQuestions.length) {
                    showModal('レッスン完了！', 'このレッスンの全問題をマスターしました！進捗をリセットして、もう一度挑戦しますか？', () => {
                        correctlyAnsweredByLesson[currentMode] = [];
                        localStorage.setItem(APP_PREFIX + 'correctlyAnsweredByLesson', JSON.stringify(correctlyAnsweredByLesson));
                        updateLessonDropdown();
                        // Directly restart the quiz for this lesson after reset
                        const lessonQuestions = allQuestions.filter(q => q.lesson === currentMode);
                        currentQuestions = lessonQuestions.slice(0, questionCount);
                        if(currentQuestions.length > 0) {
                            switchScreen(quizScreen);
                            loadQuestion();
                        }
                    });
                    return;
                }
                sourcePool = allLessonQuestions.filter(q => !correctlyAnsweredIds.includes(q.id));

            } else if (currentMode === 'incorrect') {
                sourcePool = allQuestions.filter(q => incorrectQuestionIds.includes(q.id));
                if (sourcePool.length === 0) {
                    showModal('苦手克服モード', '現在、間違えた問題がありません。よくできました！');
                    return;
                }
            } else { // random mode
                sourcePool = allQuestions;
            }

            // Lessons with long text passages that should not be shuffled
            const noShuffleLessons = [
                'l2-target', 'l2-review', 'l3-target', 'l3-review', 'l5-target', 'l5-review',
                'l6-target', 'l6-review', 'l8-target', 'l8-review', 'l9-target', 'l9-review',
                'l11-target', 'l11-review', 'l12-target', 'l12-review', 'l14-review-part67'
            ];

            if (!noShuffleLessons.includes(currentMode)) {
                shuffleArray(sourcePool);
            }
            
            currentQuestions = sourcePool.slice(0, questionCount);

            if(currentQuestions.length > 0) {
                switchScreen(quizScreen);
                loadQuestion();
            } else if (currentMode !== 'incorrect' && !isLessonMode) {
                showModal('問題エラー', '選択されたモードの問題が見つかりませんでした。');
            } else if (isLessonMode && sourcePool.length === 0) {
                    // This case is handled by the mastery check at the beginning
            }
        }

        function loadQuestion() {
            if (currentQuestions.length === 0 || currentQuestionIndex >= currentQuestions.length) {
                showQuizResult();
                return;
            }
            const question = currentQuestions[currentQuestionIndex];

            // Handle long text display and highlighting
            if (question.longText) {
                let textToShow = question.longText.replace(/\n/g, '<br>');
                if(question.highlightText) {
                    textToShow = textToShow.replace(question.highlightText, `<span class="highlight">${question.highlightText}</span>`);
                }
                longTextArea.innerHTML = textToShow;
                longTextArea.style.display = 'block';
            } else {
                longTextArea.style.display = 'none';
            }

            questionTextElement.innerHTML = question.text;
            optionsGridElement.innerHTML = '';
            feedbackMessageElement.style.display = 'none';
            feedbackMessageElement.classList.remove('correct-feedback', 'incorrect-feedback');
            explanationContentElement.classList.remove('show');
            explanationTextElement.textContent = '';
            toggleExplanationButton.classList.add('hidden');
            toggleExplanationButton.textContent = '解説▼';

            const shuffledOptions = [...question.options];
            // Do not shuffle options for long text questions to maintain consistency (A, B, C, D)
            const noShuffleLessons = [
                'l2-target', 'l2-review', 'l3-target', 'l3-review', 'l5-target', 'l5-review',
                'l6-target', 'l6-review', 'l8-target', 'l8-review', 'l9-target', 'l9-review',
                'l11-target', 'l11-review', 'l12-target', 'l12-review', 'l14-review-part67'
            ];
            if (!noShuffleLessons.includes(currentMode)) {
                shuffleArray(shuffledOptions);
            }
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = option;
                button.classList.add('option-button');
                button.dataset.option = option;
                button.addEventListener('click', () => selectOption(option, question.answer, question.id));
                optionsGridElement.appendChild(button);
            });
            updateProgressBar();
            updateNavigationButtons();
        }

        function selectOption(selectedOption, correctAnswer, questionId) {
            if (answeredQuestions.has(questionId)) return;
            disableOptions();
            const currentQuestion = currentQuestions[currentQuestionIndex];
            feedbackMessageElement.style.display = 'block';

            if (selectedOption === correctAnswer) {
                playSound('correct');
                feedbackResultElement.innerHTML = `<strong>正解！</strong>`;
                feedbackMessageElement.classList.add('correct-feedback');
                score++;

                consecutiveCorrectCounts[questionId] = (consecutiveCorrectCounts[questionId] || 0) + 1;
                
                const isLessonMode = currentMode !== 'random' && currentMode !== 'incorrect';
                if (isLessonMode) {
                    const requiredCorrects = masteryMode ? 2 : 1;
                    if (consecutiveCorrectCounts[questionId] >= requiredCorrects) {
                        if (!correctlyAnsweredByLesson[currentMode]) {
                            correctlyAnsweredByLesson[currentMode] = [];
                        }
                        if (!correctlyAnsweredByLesson[currentMode].includes(questionId)) {
                            correctlyAnsweredByLesson[currentMode].push(questionId);
                        }
                    }
                }
                
                if (masteryMode) {
                    if (consecutiveCorrectCounts[questionId] >= 2) {
                        incorrectQuestionIds = incorrectQuestionIds.filter(id => id !== questionId);
                    }
                } else {
                    incorrectQuestionIds = incorrectQuestionIds.filter(id => id !== questionId);
                }

            } else {
                playSound('incorrect');
                feedbackResultElement.innerHTML = `<strong>不正解...</strong> 正解は「${correctAnswer}」でした。`;
                feedbackMessageElement.classList.add('incorrect-feedback');
                if (!incorrectQuestionIds.includes(questionId)) incorrectQuestionIds.push(questionId);
                if (!sessionIncorrectQuestionIds.includes(questionId)) sessionIncorrectQuestionIds.push(questionId);
                consecutiveCorrectCounts[questionId] = 0;
            }
            
            answeredQuestions.add(questionId);
            localStorage.setItem(APP_PREFIX + 'incorrectQuestions', JSON.stringify(incorrectQuestionIds));
            localStorage.setItem(APP_PREFIX + 'correctlyAnsweredByLesson', JSON.stringify(correctlyAnsweredByLesson));
            localStorage.setItem(APP_PREFIX + 'consecutiveCorrectCounts', JSON.stringify(consecutiveCorrectCounts));


            optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                if (button.dataset.option === correctAnswer) button.classList.add('correct');
                else if (button.dataset.option === selectedOption) button.classList.add('incorrect');
            });

            // ここが重要: currentQuestion.explanation が存在する場合のみボタンを表示
            if (currentQuestion.explanation) {
                explanationTextElement.textContent = currentQuestion.explanation;
                toggleExplanationButton.classList.remove('hidden');
            } else {
                // 解説がない場合はボタンを隠すことを確認
                toggleExplanationButton.classList.add('hidden');
                explanationContentElement.classList.remove('show'); // 解説表示も閉じる
            }
            updateNavigationButtons();
        }

        function disableOptions() {
            optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
                button.style.cursor = 'default';
            });
        }

        function updateNavigationButtons() {
            const currentQuestion = currentQuestions[currentQuestionIndex];
            if (!currentQuestion) {
                nextButton.disabled = true;
                return;
            }
            nextButton.disabled = !answeredQuestions.has(currentQuestion.id);
            nextButton.textContent = (currentQuestionIndex === currentQuestions.length - 1 && !nextButton.disabled) ? '結果を見る' : '次の問題';
        }

        function updateProgressBar() {
            const show = showProgress && currentQuestions.length > 0;
            progressBarContainer.style.display = show ? 'block' : 'none';
            progressText.style.display = show ? 'block' : 'none';
            if (!show) return;
            
            const total = currentQuestions.length;
            const progress = total > 0 ? (currentQuestionIndex + 1) / total : 0;
            progressBar.style.width = `${progress * 100}%`;
            progressText.textContent = `${currentQuestionIndex + 1} / ${total} 問目`;
        }

        function launchConfetti() {
            if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
            confettiContainer.innerHTML = '';
            const confettiPieces = [];
            const numConfetti = 100;
            const colors = ['#f43f5e', '#38bdf8', '#fbbf24', '#34d399', '#8b5cf6'];

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[i % colors.length];
                confettiContainer.appendChild(confetti);
                
                const piece = {
                    element: confetti,
                    x: confettiContainer.clientWidth / 2,
                    y: confettiContainer.clientHeight,
                    vx: (Math.random() - 0.5) * 10,
                    vy: -Math.random() * 15 - 5, // Initial upward velocity
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 20,
                    opacity: 1
                };
                confettiPieces.push(piece);
            }

            let startTime = null;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;

                let allOffScreen = true;
                confettiPieces.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.2; // Gravity
                    p.vx *= 0.99; // Air resistance
                    p.rotation += p.rotationSpeed;
                    
                    if (p.y < confettiContainer.clientHeight + 20) { // Give some buffer
                        allOffScreen = false;
                    }

                    p.element.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rotation}deg)`;
                });

                if (allOffScreen && progress > 1000) { // Ensure it runs for at least a second
                    confettiContainer.innerHTML = '';
                    cancelAnimationFrame(confettiAnimationId);
                    confettiAnimationId = null;
                } else {
                    confettiAnimationId = requestAnimationFrame(animate);
                }
            }
            confettiAnimationId = requestAnimationFrame(animate);
        }


        function showQuizResult() {
            switchScreen(resultScreen);
            updateLessonDropdown();
            const total = currentQuestions.length;
            finalScore.textContent = `あなたのスコア: ${score} / ${total}`;

            const percentage = total === 0 ? 0 : (score / total) * 100;
            let comment = '';
            if (score === total && total > 0) {
                comment = '素晴らしい！全問正解です！🎉';
                playSound('fanfare');
                setTimeout(launchConfetti, 100); // Delay to ensure rendering
            } else if (percentage >= 80) {
                comment = 'よくできました！この調子で頑張りましょう！✨';
            } else if (percentage >= 50) {
                comment = 'もう少しです！復習して、さらに上を目指しましょう！👍';
            } else {
                comment = '頑張ろう！基礎をしっかり固めていきましょう！💪';
            }
            scoreComment.textContent = comment;
            redoIncorrectButton.style.display = sessionIncorrectQuestionIds.length > 0 ? 'block' : 'none';
        }
        
        function updateLessonDropdown() {
            const lessonOptions = document.querySelectorAll('#quizModeSelect optgroup option');
            lessonOptions.forEach(option => {
                const lessonId = option.value;
                const allLessonQuestions = allQuestions.filter(q => q.lesson === lessonId);
                const correctlyAnsweredIds = correctlyAnsweredByLesson[lessonId] || [];
                
                option.textContent = option.textContent.replace('✅ ', '');

                if (allLessonQuestions.length > 0 && correctlyAnsweredIds.length >= allLessonQuestions.length) {
                    option.textContent = '✅ ' + option.textContent;
                }
            });
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', prepareQuiz);
        nextButton.addEventListener('click', () => {
            playSound('click');
            currentQuestionIndex++;
            loadQuestion();
        });
        settingsButton.addEventListener('click', () => switchScreen(settingsScreen));
        backToStartButton.addEventListener('click', () => switchScreen(startScreen));
        interruptButton.addEventListener('click', () => {
            showModal('クイズ中断', 'クイズを中断しますか？現在の進捗は失われます。', () => {
                switchScreen(startScreen);
            });
        });
        restartButton.addEventListener('click', () => {
            playSound('click');
            switchScreen(startScreen);
            if (confettiAnimationId) {
                cancelAnimationFrame(confettiAnimationId);
                confettiContainer.innerHTML = '';
            }
        });
        redoIncorrectButton.addEventListener('click', () => {
            playSound('click');
            if (sessionIncorrectQuestionIds.length === 0) return;
            currentQuestions = allQuestions.filter(q => sessionIncorrectQuestionIds.includes(q.id));
            shuffleArray(currentQuestions);
            currentQuestionIndex = 0;
            score = 0;
            answeredQuestions.clear();
            sessionIncorrectQuestionIds = [];
            switchScreen(quizScreen);
            loadQuestion();
        });
        toggleExplanationButton.addEventListener('click', () => {
            explanationContentElement.classList.toggle('show');
            toggleExplanationButton.textContent = explanationContentElement.classList.contains('show') ? '解説▲' : '解説▼';
        });
        darkModeToggle.addEventListener('change', (e) => setDarkMode(e.target.checked));
        themeColorCircles.forEach(circle => {
            circle.addEventListener('click', () => {
                themeColorCircles.forEach(c => c.classList.remove('selected'));
                circle.classList.add('selected');
                setThemeColor(circle.dataset.theme);
            });
        });
        questionCountSelect.addEventListener('change', (e) => localStorage.setItem(APP_PREFIX + 'questionCount', e.target.value));
        showProgressToggle.addEventListener('change', (e) => {
            showProgress = e.target.checked;
            localStorage.setItem(APP_PREFIX + 'showProgress', String(showProgress));
            updateProgressBar();
        });
        enableSoundToggle.addEventListener('change', (e) => {
            enableSound = e.target.checked;
            localStorage.setItem(APP_PREFIX + 'enableSound', String(enableSound));
        });
        masteryModeToggle.addEventListener('change', (e) => {
            masteryMode = e.target.checked;
            localStorage.setItem(APP_PREFIX + 'masteryMode', String(masteryMode));
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem(APP_PREFIX + 'darkMode') === 'true';
            document.body.classList.toggle('dark-mode', isDark);
            darkModeToggle.checked = isDark;
            
            const savedTheme = localStorage.getItem(APP_PREFIX + 'themeColor') || 'default';
            document.querySelector(`.color-circle[data-theme="${savedTheme}"]`)?.classList.add('selected');
            
            applyColors(savedTheme, isDark);

            const storedIncorrect = localStorage.getItem(APP_PREFIX + 'incorrectQuestions');
            if (storedIncorrect) {
                try { incorrectQuestionIds = JSON.parse(storedIncorrect); } catch { incorrectQuestionIds = []; }
            }
            const storedCorrect = localStorage.getItem(APP_PREFIX + 'correctlyAnsweredByLesson');
            if (storedCorrect) {
                try { correctlyAnsweredByLesson = JSON.parse(storedCorrect); } catch { correctlyAnsweredByLesson = {}; }
            }
            const storedConsecutive = localStorage.getItem(APP_PREFIX + 'consecutiveCorrectCounts');
            if (storedConsecutive) {
                try { consecutiveCorrectCounts = JSON.parse(storedConsecutive); } catch { consecutiveCorrectCounts = {}; }
            }

            quizModeSelect.value = localStorage.getItem(APP_PREFIX + 'lastSelectedMode') || 'random';
            questionCountSelect.value = localStorage.getItem(APP_PREFIX + 'questionCount') || '10';
            showProgress = localStorage.getItem(APP_PREFIX + 'showProgress') !== 'false';
            showProgressToggle.checked = showProgress;
            enableSound = localStorage.getItem(APP_PREFIX + 'enableSound') !== 'false';
            enableSoundToggle.checked = enableSound;
            masteryMode = localStorage.getItem(APP_PREFIX + 'masteryMode') === 'true';
            masteryModeToggle.checked = masteryMode;

            updateLessonDropdown();
            switchScreen(startScreen);
        });
    </script>
</body>
</html>
