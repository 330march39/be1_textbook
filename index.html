<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEⅠ テキスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tone.js library for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Mode Default Colors */
            --bg-primary: #f0f9ff;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --button-bg-default: #f1f5f9;
            --button-text-default: #334155;
            --button-border-default: #cbd5e1;
            --nav-button-bg: #0ea5e9;
            --nav-button-hover-bg: #0284c7;
            --nav-button-shadow: rgba(14, 165, 233, 0.3);
            --start-button-bg: #10b981;
            --start-button-hover-bg: #059669;
            --start-button-shadow: rgba(16, 185, 129, 0.3);
            --interrupt-button-bg: #ef4444;
            --interrupt-button-hover-bg: #dc2626;
            --interrupt-button-shadow: rgba(239, 68, 68, 0.3);
            --progress-bar-bg: #0ea5e9;
            --feedback-bg: #f8fafc;
            --feedback-border: #e2e8f0;
            --correct-feedback-text: #15803d;
            --correct-feedback-border: #22c55e;
            --incorrect-feedback-text: #b91c1c;
            --incorrect-feedback-border: #ef4444;
            --correct-option-bg: #dcfce7;
            --incorrect-option-bg: #fee2e2;
            --score-color: #0c4a6e;
            --score-comment-color: #0369a1;
            --settings-button-bg: #6366f1;
            --settings-button-hover-bg: #4f46e5;
            --settings-button-shadow: rgba(99, 102, 241, 0.3);
            --themed-text-color: #0c4a6e;
            --highlight-bg: #fef9c3;
            --highlight-text: #713f12;
            
            /* Themed Background Colors */
            --bg-primary-default: #f0f9ff;
            --bg-primary-red: #fff1f2;
            --bg-primary-green: #f0fdf4;
            --bg-primary-indigo: #f5f3ff;
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --button-bg-default: #334155;
            --button-text-default: #e2e8f0;
            --button-border-default: #475569;
            --nav-button-bg: #38bdf8;
            --nav-button-hover-bg: #0ea5e9;
            --nav-button-shadow: rgba(56, 189, 248, 0.3);
            --start-button-bg: #2dd4bf;
            --start-button-hover-bg: #14b8a6;
            --start-button-shadow: rgba(45, 212, 191, 0.3);
            --interrupt-button-bg: #f87171;
            --interrupt-button-hover-bg: #ef4444;
            --interrupt-button-shadow: rgba(248, 113, 113, 0.3);
            --progress-bar-bg: #38bdf8;
            --feedback-bg: #334155;
            --feedback-border: #475569;
            --correct-feedback-text: #a7f3d0;
            --correct-feedback-border: #4ade80;
            --incorrect-feedback-text: #fecaca;
            --incorrect-feedback-border: #f87171;
            --correct-option-bg: #14532d;
            --incorrect-option-bg: #7f1d1d;
            --score-color: #e0f2fe;
            --score-comment-color: #7dd3fc;
            --settings-button-bg: #818cf8;
            --settings-button-hover-bg: #6366f1;
            --settings-button-shadow: rgba(129, 140, 248, 0.3);
            --themed-text-color: #e0f2fe;
            --highlight-bg: #422006;
            --highlight-text: #fef3c7;

            /* Themed Background Colors (Dark) */
            --bg-primary-default: #0f172a;
            --bg-primary-red: #261012;
            --bg-primary-green: #0d1f12;
            --bg-primary-indigo: #1a1b2d;
        }

        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        .container {
            background-color: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            padding: 25px;
            width: 100%;
            max-width: 700px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            z-index: 1;
            transition: background-color 0.3s ease;
        }
        .screen {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        .screen.active {
            display: flex;
        }
        .main-title {
            color: var(--themed-text-color);
            transition: color 0.3s ease;
        }
        .question-area {
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
            text-align: left;
        }
        .long-text-area {
            background-color: var(--feedback-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            text-align: left;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-primary);
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
        }
        .long-text-area .highlight {
            background-color: var(--highlight-bg);
            color: var(--highlight-text);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        .question-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--themed-text-color);
            margin-bottom: 10px;
            transition: color 0.3s ease;
            width: 100%;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        .option-button {
            background-color: var(--button-bg-default);
            color: var(--button-text-default);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--button-border-default);
            text-align: left;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            line-height: 1.5;
        }
        .option-button:hover {
            background-color: var(--button-border-default);
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }
        .option-button.correct {
            background-color: var(--correct-option-bg);
            border-color: var(--correct-feedback-border);
            color: var(--correct-feedback-text);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
        }
        .option-button.incorrect {
            background-color: var(--incorrect-option-bg);
            border-color: var(--incorrect-feedback-border);
            color: var(--incorrect-feedback-text);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }
        .navigation-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-button {
            background-color: var(--nav-button-bg);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px var(--nav-button-shadow);
            border: none;
        }
        .nav-button:hover {
            background-color: var(--nav-button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 7px 20px var(--nav-button-shadow);
        }
        .nav-button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
        .feedback-message {
            margin-top: 10px;
            font-size: 1rem;
            font-weight: 600;
            text-align: left;
            padding: 10px 15px;
            border-radius: 12px;
            background-color: var(--feedback-bg);
            border: 1px solid var(--feedback-border);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        .feedback-message.correct-feedback {
            color: var(--correct-feedback-text);
            border-color: var(--correct-feedback-border);
        }
        .feedback-message.incorrect-feedback {
            color: var(--incorrect-feedback-text);
            border-color: var(--incorrect-feedback-border);
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            min-height: 24px;
            flex-wrap: wrap; /* nowrap から wrap に変更 */
        }
        .feedback-result {
            flex-grow: 1;
        }
        .feedback-result strong {
            font-size: 1.1rem;
        }
        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, margin-top 0.4s ease-out;
            padding-top: 0;
            margin-top: 0;
        }
        .explanation-content.show {
            max-height: 200px;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid var(--feedback-border);
        }
        .explanation-text {
            font-weight: 400;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }
        .feedback-message.correct-feedback .explanation-text {
            color: var(--correct-feedback-text);
        }
        .feedback-message.incorrect-feedback .explanation-text {
            color: var(--incorrect-feedback-text);
        }
        .toggle-explanation-button {
            background-color: var(--nav-button-bg);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px var(--nav-button-shadow);
            flex-shrink: 0;
        }
        .toggle-explanation-button:hover {
            transform: translateY(-1px);
        }
        .toggle-explanation-button.hidden {
            display: none;
        }
        .score-area {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--score-color);
            margin-top: 25px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            transition: color 0.3s ease;
        }
        .score-comment {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--score-comment-color);
            margin-top: 10px;
            transition: color 0.3s ease;
        }
        .mode-selection-dropdown, .question-count-selection {
            margin-bottom: 15px;
        }
        .mode-selection-dropdown label, .question-count-selection label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .mode-selection-dropdown select, .question-count-selection select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--button-border-default);
            font-size: 1rem;
            background-color: var(--button-bg-default);
            color: var(--button-text-default);
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%23333%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1.2em;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .start-button {
            background-color: var(--start-button-bg);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px var(--start-button-shadow);
            margin-top: 20px;
            border: none;
        }
        .start-button:hover {
            background-color: var(--start-button-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--start-button-shadow);
        }
        #settingsButton {
            background-color: var(--settings-button-bg);
            box-shadow: 0 5px 15px var(--settings-button-shadow);
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-secondary); padding: 35px; border-radius: 20px; text-align: center; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); max-width: 450px; width: 90%; transform: translateY(-30px); transition: transform 0.3s ease, background-color 0.3s ease; }
        .modal.show .modal-content { transform: translateY(0); }
        .modal-title { font-size: 2rem; font-weight: 800; color: var(--score-color); margin-bottom: 20px; transition: color 0.3s ease; }
        .modal-message { font-size: 1.2rem; color: var(--text-primary); margin-bottom: 30px; line-height: 1.6; transition: color 0.3s ease; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-button { background-color: var(--nav-button-bg); color: white; padding: 12px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; box-shadow: 0 4px 10px var(--nav-button-shadow); border: none; }
        .modal-button:hover { background-color: var(--nav-button-hover-bg); transform: translateY(-1px); }
        #modalCancelButton { background-color: #64748b; box-shadow: 0 4px 10px rgba(100, 116, 139, 0.3); }
        #modalCancelButton:hover { background-color: #475569; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 10px; height: 15px; margin-top: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; background-color: var(--progress-bar-bg); border-radius: 10px; transition: width 0.3s ease-in-out, background-color 0.3s ease; }
        .progress-text { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 10px; transition: color 0.3s ease; }
        .quiz-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1.5rem;
            padding-bottom: 0.5rem;
            gap: 1rem;
        }
        .quiz-header .main-title {
            flex-grow: 1;
            text-align: center;
            font-size: 1.5rem;
            margin: 0;
            padding: 0 4rem; /* Add padding to avoid overlap */
        }
        #interruptButton {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            padding: 8px 15px;
            font-size: 0.8rem;
        }
        
        .confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f06; opacity: 1; }
        
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--button-border-default); flex-wrap: nowrap; gap: 1rem;}
        .settings-option:last-child { border-bottom: none; }
        .settings-option-label { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; min-width: 0; }
        .settings-option-label label { font-size: 1.1rem; color: var(--text-primary); font-weight: 600; }
        .settings-option-label p { font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0 0 0; text-align: left; }
        .theme-colors { display: flex; gap: 10px; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; }
        .color-circle.selected { border-color: var(--nav-button-bg); }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; margin-left: auto; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--nav-button-bg); }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (min-width: 640px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
            .quiz-header .main-title {
                font-size: 1.875rem; /* text-3xl */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="confettiContainer" class="confetti-container"></div>

        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <h1 class="text-3xl font-bold mb-6 main-title">BEⅠ テキスト</h1>
            <p class="text-lg mb-4" style="color: var(--text-primary);">学習したいモードを選択してください。</p>
            <div class="mode-selection-dropdown">
                <select id="quizModeSelect">
                    <option value="random">全範囲からランダム出題</option>
                    <option value="incorrect">苦手克服モード</option>
                    <optgroup label="Lesson 1">
                        <option value="l1-target">TODAY's TARGET TEST</option>
                        <option value="l1-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 2">
                        <option value="l2-target">TODAY's TARGET TEST</option>
                        <option value="l2-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 3">
                        <option value="l3-target">TODAY's TARGET TEST</option>
                        <option value="l3-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 4">
                        <option value="l4-target">TODAY's TARGET TEST</option>
                        <option value="l4-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 5">
                        <option value="l5-target">TODAY's TARGET TEST</option>
                        <option value="l5-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 6">
                        <option value="l6-target">TODAY's TARGET TEST</option>
                        <option value="l6-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 7">
                        <option value="l7-target">TODAY's TARGET TEST</option>
                        <option value="l7-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 8">
                        <option value="l8-target">TODAY's TARGET TEST</option>
                        <option value="l8-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 9">
                        <option value="l9-target">TODAY's TARGET TEST</option>
                        <option value="l9-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 10">
                        <option value="l10-target">TODAY's TARGET TEST</option>
                        <option value="l10-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 11">
                        <option value="l11-target">TODAY's TARGET TEST</option>
                        <option value="l11-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 12">
                        <option value="l12-target">TODAY's TARGET TEST</option>
                        <option value="l12-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="Lesson 13">
                        <option value="l13-target">TODAY's TARGET TEST</option>
                        <option value="l13-review">Review Quiz</option>
                    </optgroup>
                    <optgroup label="総復習">
                        <option value="l14-review-part5">Part 5 Review Test</option>
                        <option value="l14-review-part67">Part 6 & 7 Review Test</option>
                    </optgroup>
                </select>
            </div>
            <button id="startButton" class="start-button">クイズ開始</button>
            <button id="settingsButton" class="nav-button">設定</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen">
            <div class="quiz-header">
                <h1 class="main-title font-bold">BEⅠ テキスト</h1>
                <button id="interruptButton" class="nav-button">中断</button>
            </div>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText" class="progress-text"></div>

            <div class="question-area">
                <div id="longTextArea" class="long-text-area" style="display: none;"></div>
                <div id="questionText" class="question-text"></div>
            </div>

            <div id="optionsGrid" class="options-grid"></div>

            <div id="feedbackMessage" class="feedback-message" style="display: none;">
                <div class="feedback-header">
                    <div id="feedbackResult"></div>
                    <button id="toggleExplanationButton" class="toggle-explanation-button hidden">解説▼</button>
                </div>
                <div id="explanationContent" class="explanation-content">
                    <div class="explanation-text"></div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button id="nextButton" class="nav-button">次の問題</button>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen">
            <h1 class="text-3xl font-bold mb-6 main-title">BEⅠ テキスト</h1>
            <h2 class="text-2xl font-bold mb-4" style="color: var(--score-color);">クイズ結果</h2>
            <div id="finalScore" class="score-area"></div>
            <div id="scoreComment" class="score-comment"></div>
            <button id="restartButton" class="nav-button mt-6">もう一度プレイ</button>
            <button id="redoIncorrectButton" class="nav-button mt-2" style="background-color: var(--interrupt-button-bg);">間違えた問題をもう一度やる</button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <h1 class="text-3xl font-bold mb-6 main-title">BEⅠ テキスト</h1>
            <h2 class="text-2xl font-bold mb-4 main-title">設定</h2>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="darkModeToggle">ダークモード</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label>テーマカラー</label>
                </div>
                <div class="theme-colors">
                    <div class="color-circle" data-theme="default" style="background-color: #0ea5e9;"></div>
                    <div class="color-circle" data-theme="red" style="background-color: #ef4444;"></div>
                    <div class="color-circle" data-theme="green" style="background-color: #10b981;"></div>
                    <div class="color-circle" data-theme="indigo" style="background-color: #6366f1;"></div>
                </div>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="questionCountSelect">問題数</label>
                </div>
                <select id="questionCountSelect">
                    <option value="5">5問</option>
                    <option value="10">10問</option>
                    <option value="15">15問</option>
                    <option value="20">20問</option>
                </select>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="showProgressToggle">進捗状況を表示</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="showProgressToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="enableSoundToggle">効果音</label>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="enableSoundToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div class="settings-option-label">
                    <label for="masteryModeToggle">習得モード</label>
                    <p>すべての問題は2回連続で正解するまで「習得済み」になりません。</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="masteryModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="backToStartButton" class="nav-button mt-6">戻る</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="modal-title"></h2>
            <p id="modalMessage" class="modal-message"></p>
            <div class="modal-buttons">
                <button id="modalConfirmButton" class="modal-button">はい</button>
                <button id="modalCancelButton" class="modal-button">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // --- App Specific ID ---
        const APP_PREFIX = 'BASIC_ENGLISH_1_QUIZ_V2_'; // Changed to V2 to reset storage

        // --- Question Data ---
        const allQuestions = [
            // Lesson 1: TODAY's TARGET TEST
{ id: 'l1-t-1', lesson: 'l1-target', text: "As soon as the Claudia 5.0 was launched, it became the most ___ software that the company had ever released.", options: ["profit", "profitable", "profitably", "profits"], answer: "profitable", explanation: "名詞 'software' を説明するために形容詞 'profitable' が必要です。" },
{ id: 'l1-t-2', lesson: 'l1-target', text: "The tennis player said the biggest ___ of her professional career was becoming the world champion three times in a row.", options: ["achievable", "achieve", "achievement", "achiever"], answer: "achievement", explanation: "文の主語として名詞 'achievement' が必要です。" },
{ id: 'l1-t-3', lesson: 'l1-target', text: "This browser ___ updates itself whenever it detects that a new version of the browser is available.", options: ["automate", "automatic", "automatically", "automation"], answer: "automatically", explanation: "ブラウザがどのように更新されるかを説明するために副詞 'automatically' が必要です。" },
{ id: 'l1-t-4', lesson: 'l1-target', text: "Jim Coogan panicked a little when his boss told him to ___ the sales report by tomorrow morning.", options: ["final", "finale", "finalize", "finally"], answer: "finalize", explanation: "上司からの指示を完了するために動詞 'finalize' が必要です。" },
{ id: 'l1-t-5', lesson: 'l1-target', text: "We are sorry to tell you that the item you ordered is backordered and will not be ___ until the middle of May.", options: ["avail", "availability", "available", "availably"], answer: "available", explanation: "品物の状態を説明するために形容詞 'available' が必要です。" },
{ id: 'l1-t-6', lesson: 'l1-target', text: "The wife was really excited to hear about her husband's ___ to marketing manager.", options: ["promote", "promoter", "promotion", "promotional"], answer: "promotion", explanation: "新しい役職に昇進する出来事を説明するために名詞 'promotion' が必要です。" },
{ id: 'l1-t-7', lesson: 'l1-target', text: "The grocery store is known for selling only vegetables and fruits that are ___ grown or produced.", options: ["local", "localization", "localize", "locally"], answer: "locally", explanation: "野菜や果物がどのように栽培されているかを説明するために副詞 'locally' が必要です。" },
{ id: 'l1-t-8', lesson: 'l1-target', text: "Keiko Manning, an ___ candidate, won the election with more than 50 percent of the vote.", options: ["independence", "independency", "independent", "independently"], answer: "independent", explanation: "名詞 'candidate' を説明するために形容詞 'independent' が必要です。" },
{ id: 'l1-t-9', lesson: 'l1-target', text: "According to recent surveys, online education's accessibility and ___ are attracting millions of people to enroll.", options: ["afford", "affordability", "affordable", "affording"], answer: "affordability", explanation: "「accessibility」と並列になる名詞 'affordability' が必要です。" },
{ id: 'l1-t-10', lesson: 'l1-target', text: "The boss told Kim Lee that she was not chosen as the team leader ___ because of lack of experience, not because of her gender.", options: ["simple", "simplicity", "simplify", "simply"], answer: "simply", explanation: "ここでは「単に」「ただ」という意味で副詞 'simply' が使われています。" },
{ id: 'l1-t-11', lesson: 'l1-target', text: "Ken Boyd, the Chairperson of Medicom, Inc., will give his first lecture tonight on 'How to instantly ___ potential customers.'", options: ["attract", "attraction", "attractive", "attractively"], answer: "attract", explanation: "不定詞を形成するために 'to' の後に動詞 'attract' が必要です。" },
{ id: 'l1-t-12', lesson: 'l1-target', text: "The salesperson recommended the bamboo flooring to the client because it is ___ and inexpensive.", options: ["durability", "durable", "durables", "durably"], answer: "durable", explanation: "「inexpensive」と並列で床材を説明するために形容詞 'durable' が必要です。" },
{ id: 'l1-t-13', lesson: 'l1-target', text: "The results shows that the ___ of second-hand smoke on children is worse than expected.", options: ["effect", "effective", "effectively", "effects"], answer: "effects", explanation: "煙の複数の影響を指すため、複数形の名詞 'effects' が必要です。" },
{ id: 'l1-t-14', lesson: 'l1-target', text: "The following study is about how water flows and ___ freely between the rocks in a stream.", options: ["smooth", "smoothen", "smoothly", "smoothness"], answer: "smoothly", explanation: "水がどのように流れるかを説明するために副詞 'smoothly' が必要です。" },
{ id: 'l1-t-15', lesson: 'l1-target', text: "It would be greatly ___ if you could send me the latest catalogue of your products.", options: ["appreciate", "appreciated", "appreciation", "appreciatively"], answer: "appreciated", explanation: "ここでは受動態の構造で過去分詞 'appreciated' が使われています。" },
{ id: 'l1-t-16', lesson: 'l1-target', text: "Sam Kelly was shocked to receive the news that numerous ___ had been made with his credit card without his knowledge.", options: ["purchasable", "purchase", "purchaser", "purchases"], answer: "purchases", explanation: "「numerous」に合わせて複数形の名詞 'purchases' が必要です。" },

// Lesson 1: Review Quiz
{ id: 'l1-r-1', lesson: 'l1-review', text: "It is expected that Zin Motors will make an ___ about the merger with DCI Autos today.", options: ["announce", "announced", "announcement", "announcer"], answer: "announcement", explanation: "「make an」の後に名詞 'announcement' が必要です。" },
{ id: 'l1-r-2', lesson: 'l1-review', text: "The market analyst was accused of passing ___ information to a trader at an investment firm today.", options: ["confidential", "confidentialities", "confidentiality", "confidentially"], answer: "confidential", explanation: "「information」を説明するために形容詞 'confidential' が必要です。" },
{ id: 'l1-r-3', lesson: 'l1-review', text: "Going against public opinion, the congress approved the new tax act by a ___ vote of 400 to 15.", options: ["overwhelm", "overwhelmed", "overwhelming", "overwhelmingly"], answer: "overwhelming", explanation: "「vote」を説明するために形容詞 'overwhelming' が必要です。" },
{ id: 'l1-r-4', lesson: 'l1-review', text: "When he was asked to ___ a few of his favorite things about Everton, the governor couldn't give an immediate reply.", options: ["namable", "name", "namely", "names"], answer: "name", explanation: "ここでは「リストアップする」または「特定する」という意味の動詞 'name' が必要です。" },
{ id: 'l1-r-5', lesson: 'l1-review', text: "Local media reported that the young entrepreneur made a generous ___ to the community college he graduated from.", options: ["donate", "donated", "donation", "donator"], answer: "donation", explanation: "「made a generous」の後に名詞 'donation' が必要です。" },
{ id: 'l1-r-6', lesson: 'l1-review', text: "In the speech, the project leader commended his team for being efficient, reliable and highly ___.", options: ["organization", "organize", "organized", "organizer"], answer: "organized", explanation: "チームを説明するために形容詞 'organized' が必要で、「efficient」と「reliable」と並列になっています。" },
{ id: 'l1-r-7', lesson: 'l1-review', text: "The talk show host ___ apologized for making offensive remarks about the Prime Minister.", options: ["public", "publicity", "publicize", "publicly"], answer: "publicly", explanation: "彼がどのように謝罪したかを説明するために副詞 'publicly' が必要です。" },
{ id: 'l1-r-8', lesson: 'l1-review', text: "Liam Woods is well known as a social ___, best-selling author and radio talk-show host.", options: ["active", "actively", "activist", "activity"], answer: "activist", explanation: "「著者」や「司会者」と並列で人物を説明するために名詞 'activist' が必要です。" },
   
            // Lesson 2: TODAY's TARGET TEST
            { id: 'l2-t-1', lesson: 'l2-target', longText: "The future of what would become Mesa County's tallest building is still uncertain after ___ Vince Bolten admitted he didn't have sufficient financing for the project, the Daily News reported today. Bolten's firm Springton Industries had been expected to break ground by year's end on the 62-story building at the corner of 17th and St. Anne Avenue in downtown Milton. The delay means that Springton Industries will need to update architectural plans to comply with the latest building codes and go through the city's lengthy approval process again, a city hall spokesperson said.", text: "1. The future of what would become Mesa County's tallest building is still uncertain after ___ Vince Bolten admitted he didn't have sufficient financing for the project...", highlightText: "uncertain after ___ Vince Bolten admitted", options: ["develop", "developer", "development", "developmental"], answer: "developer", explanation: "空欄には、建物のプロジェクトに関わる人物を示す名詞 'developer' が適切です。" },
            { id: 'l2-t-2', lesson: 'l2-target', longText: "A majority of Milton's voters had approved the skyscraper, while residents of some nearby neighborhoods opposed it. A lawsuit aimed at stopping construction was ___ in a Mesa County court ruling. Now that legal issues have been settled, the financial problems are all that's blocking the way forward on the project.", text: "2. A lawsuit aimed at stopping construction was ___ in a Mesa County court ruling...", highlightText: "A lawsuit aimed at stopping construction was ___ in a Mesa County court ruling.", options: ["historian", "historic", "historically", "history"], answer: "historic", explanation: "文脈から、名詞 'ruling' を修飾する形容詞 'historic' が適切です。" },
            { id: 'l2-t-3', lesson: 'l2-target', longText: "A lawsuit aimed at stopping construction was ___ in a Mesa County court ruling. Now that legal issues have been settled, the financial problems are all that's blocking the way forward on the project.", text: "3. A lawsuit aimed at stopping construction was ___ in a Mesa County court ruling.", highlightText: "A lawsuit aimed at stopping construction was ___ in a Mesa County court ruling.", options: ["rejectable", "rejected", "rejection", "rejective"], answer: "rejected", explanation: "受動態の動詞 'was rejected' が必要です。" },
            { id: 'l2-t-4', lesson: 'l2-target', longText: "Book Signing Event\nCapital Books\n2021 18th Street\nWilmington\n\nFebruary 25, 6:30 p.m.\n\nJoin us at Capital Books for an exciting event. ___ author Jessica Parker will be reading selections from her best-seller Night in the Capital and will also answer audience questions about mystery writing.", text: "4. Join us at Capital Books for an exciting event. ___ author Jessica Parker will be reading...", highlightText: "___ author Jessica Parker will be reading", options: ["Local", "Locality", "Localization", "Localize"], answer: "Local", explanation: "名詞 'author' を修飾する形容詞 'Local' が適切です。" },
            { id: 'l2-t-5', lesson: 'l2-target', longText: "What makes this book so special to Wilmington ___ is that it's set right here in our fair city. Readers will with delight the neighborhoods and streets of Wilmington, while following the twists and turns of crime fiction at its best.", text: "5. What makes this book so special to Wilmington ___ is that it's set right here in our fair city.", highlightText: "special to Wilmington ___ is that it's set right here", options: ["residence", "residential", "residents", "residing"], answer: "residents", explanation: "Wilmingtonの住民を指す名詞 'residents' が適切です。" },
            { id: 'l2-t-6', lesson: 'l2-target', longText: "Readers will ___ with delight the neighborhoods and streets of Wilmington, while following the twists and turns of crime fiction at its best. Bring your book for Ms. Parker to sign or purchase a hardback copy at a special discount, ten-percent off at the event only.", text: "6. Readers will ___ with delight the neighborhoods and streets of Wilmington...", highlightText: "Readers will ___ with delight the neighborhoods", options: ["recognition", "recognizable", "recognizably", "recognize"], answer: "recognize", explanation: "助動詞 'will' の後に動詞の原形 'recognize' が必要です。" },
            { id: 'l2-t-7', lesson: 'l2-target', longText: "SAFETY RECALL\nCRAMER BOY'S HOODED FLEECE\nStyle No. 41204106\n\nCramer Clothing, in cooperation with the Consumer Product Safety Agency, is ___ recalling a boy's hooded long sleeve fleece jacket.", text: "7. Cramer Clothing, in cooperation with the Consumer Product Safety Agency, is ___ recalling a boy's hooded long sleeve fleece jacket.", highlightText: "is ___ recalling a boy's hooded long sleeve fleece jacket", options: ["voluntary", "voluntarily", "volunteer", "volunteering"], answer: "voluntarily", explanation: "動詞 'recalling' を修飾する副詞 'voluntarily' が適切です。" },
            { id: 'l2-t-8', lesson: 'l2-target', longText: "This hooded long sleeve fleece jacket has a neck drawstring that could become tied too ___ for children to undo. In a small number of cases, the string posed a risk to wearers.", text: "8. This hooded long sleeve fleece jacket has a neck drawstring that could become tied too ___ for children to undo.", highlightText: "tied too ___ for children to undo", options: ["tight", "tighten", "tightly", "tightness"], answer: "tightly", explanation: "動詞 'tied' を修飾する副詞 'tightly' が適切です。" },
            { id: 'l2-t-9', lesson: 'l2-target', longText: "CHILDREN SHOULD STOP WEARING THIS GARMENT IMMEDIATELY.\n\nParents can ___ the safety risk by cutting and removing the neck drawstring. Customers may also return this outerwear to the store in which it was purchased for a full refund...", text: "9. Parents can ___ the safety risk by cutting and removing the neck drawstring.", highlightText: "Parents can ___ the safety risk by cutting", options: ["eliminate", "elimination", "eliminator", "eliminatory"], answer: "eliminate", explanation: "助動詞 'can' の後に動詞の原形 'eliminate' が必要です。" },

            // Lesson 2: Review Quiz
            { id: 'l2-r-1', lesson: 'l2-review', longText: "To: All employees\nFrom: Jim Chelsea\nDate: July 1\nSubject: New charity campaign.\n\nStratford, Inc is proud of the efforts its employees make to ___ others in our community. Whether on a personal volunteer basis or through our in-house charity programs, our employees play a vital role in making Heath City a great place to live.", text: "1. Stratford, Inc is proud of the efforts its employees make to ___ others in our community.", highlightText: "make to ___ others in our community", options: ["assist", "assistance", "assistant", "assistive"], answer: "assist", explanation: "不定詞 'to' の後に動詞の原形 'assist' が必要です。" },
            { id: 'l2-r-2', lesson: 'l2-review', longText: "In that spirit, I'm happy to announce our most recent campaign in support of Second Chance, a non-profit organization for local residents who need a temporary place to live. Starting this week and ___ to the end of the month, you can make contributions to Second Chance in cash or by donating any of the items listed on their website.", text: "2. Starting this week and ___ to the end of the month, you can make contributions...", highlightText: "and ___ to the end of the month", options: ["continual", "continue", "continuing", "continuity"], answer: "continuing", explanation: "「〜まで続く」という意味で現在分詞 'continuing' が適切です。" },
            { id: 'l2-r-3', lesson: 'l2-review', longText: "They need blankets, towels, pillows, and the like. See the whole list at www.secondchance.org.\n\nLet us keep up the great ___ of helping our community. Thanks for your participation.", text: "3. Let us keep up the great ___ of helping our community.", highlightText: "the great ___ of helping our community", options: ["tradition", "traditional", "traditionally", "traditionist"], answer: "tradition", explanation: "「素晴らしい伝統」という意味で名詞 'tradition' が適切です。" },
            { id: 'l2-r-4', lesson: 'l2-review', longText: "Two businesses win Workplace Excellence Awards for the Year\n\nThe National Society for Human Resource Management has chosen Zero One and Wheel as the winners of its annual Workplace Excellence Awards. Each year, the NSHRM recognizes companies that have made their work environments desirable for employees. Zero One, the ___ giant, won the award for large companies.", text: "4. Zero One, the ___ giant, won the award for large companies.", highlightText: "Zero One, the ___ giant", options: ["technological", "technologically", "technologist", "technology"], answer: "technology", explanation: "「テクノロジーの巨人」という意味で名詞 'technology' が適切です。" },
            { id: 'l2-r-5', lesson: 'l2-review', longText: "The company's flexible schedules, job sharing, employee thank-you and recognition programs were all reasons for being chosen. Wheel, a children's toy company, received the honor for small companies. NSHRM judges pointed to the company's annual reward trips, commitment to volunteer service and encouragement of the ___ and personal growth of its staff.", text: "5. ...encouragement of the ___ and personal growth of its staff.", highlightText: "encouragement of the ___ and personal growth", options: ["profession", "professional", "professionalism", "professionally"], answer: "professional", explanation: "「専門的な成長」という意味で形容詞 'professional' が適切です。" },

            // Lesson 3: TODAY's TARGET TEST
            { id: 'l3-t-1', lesson: 'l3-target', longText: "Gordon's Annual Anniversary Sale Starts Wednesday!\n\nOur 35th annual anniversary sale starts this Wednesday, September 15th! For five days only, all items in the store are discounted up to 50 percent. That includes this season's newest fashions! We are the only retailer to offer sale prices on this season's top clothing lines!", text: "1. According to the advertisement, what is unique about Gordon's sale?", highlightText: "We are the only retailer to offer sale prices on this season's top clothing lines!", options: ["The sale is held more days than at other stores in the area.", "They hold the sale each month.", "They offer discounts on the current season's clothing lines.", "They offer extended shopping hours."], answer: "They offer discounts on the current season's clothing lines.", explanation: "広告のハイライト部分に「今シーズンのトップ衣料品ラインにセール価格を提供する唯一の小売業者」と記載されています。" },
            { id: 'l3-t-2', lesson: 'l3-target', longText: "Store hours will be extended at all locations, depending on the individual store's location. Some downtown and mall locations will be open until midnight all five days. See individual stores for hours. All stores will remain open until midnight on the final day.", text: "2. What will be changed at Gordon's on Sunday?", highlightText: "All stores will remain open until midnight on the final day.", options: ["The closing time", "The discount rates", "The items on sale", "The number of staff"], answer: "The closing time", explanation: "最終日（日曜日）は深夜まで営業すると記載されており、閉店時間が変更されます。" },
            { id: 'l3-t-3', lesson: 'l3-target', longText: "Weekly Specials at Johnson's Market\n\nWe always guarantee the lowest prices in town! 7 days a week!\n\nThis week's specials (good through Friday, May 3) include:\n-Finley Farms boneless skinless chicken thighs: $3.49/lb.\n-Locally raised rib-eye steaks: $4.99/lb.\n-Fresh blueberries 6 oz package: 2 for $3.00\n-Greek yogurt, 4 oz size: 10 for $10.00\n-Luigi's dry pasta (assorted varieties): 99 cents each", text: "3. What is true about the week's specials?", highlightText: "-Fresh blueberries 6 oz package: 2 for $3.00", options: ["Blueberries are sold in packages.", "Greek yogurt has several flavors.", "Fresh pasta is on sale.", "The beef steak is imported."], answer: "Blueberries are sold in packages.", explanation: "ハイライト部分に「Fresh blueberries 6 oz package」と記載されています。" },
            { id: 'l3-t-4', lesson: 'l3-target', longText: "We're open from 9:00 am. until midnight every day of the week to serve you. Stop by and visit our in-store bakery, meat department and delicatessen!", text: "4. What service does the market NOT offer in-store?", highlightText: "in-store bakery, meat department and delicatessen", options: ["A bakery", "A butcher shop", "A deli", "A floral department"], answer: "A floral department", explanation: "店内で提供されるサービスとして、パン屋、精肉部門、デリカテッセンが挙げられていますが、花屋は含まれていません。" },
            { id: 'l3-t-5', lesson: 'l3-target', longText: "DYD Renovations is the leading commercial renovations service in the state. We specialize in the hospitality and housing industries and have performed major renovations for leading hotel chains, condominiums and senior care facilities. No job is too big for DYD. Our services include remodeling, plumbing, electrical work and even landscaping.", text: "5. What service is NOT mentioned in the advertisement?", highlightText: "Our services include remodeling, plumbing, electrical work and even landscaping.", options: ["Architectural planning", "Construction", "Estimations", "Plumbing"], answer: "Architectural planning", explanation: "広告には「リフォーム、配管、電気工事、造園」と記載されていますが、建築計画については言及されていません。" },
            { id: 'l3-t-6', lesson: 'l3-target', longText: "We are able to offer all these services because we have the largest staff of experts and professionals in the state. DYD has been in business for over 40 years.", text: "6. Why is DYD capable of such a wide array of services?", highlightText: "we have the largest staff of experts and professionals in the state", options: ["They contract with other businesses.", "They have an enormous pool of employees.", "They have many years of experience.", "They only serve one city."], answer: "They have an enormous pool of employees.", explanation: "ハイライト部分に「州内で最大の専門家とプロのスタッフを擁している」と記載されています。" },
            { id: 'l3-t-7', lesson: 'l3-target', longText: "Visit our website to read testimonials from satisfied clients, or to book a consultation with one of our estimators today to get a free, detailed quote for your renovation project. We look forward to serving you!", text: "7. What can one do on DYD's website?", highlightText: "book a consultation with one of our estimators today to get a free, detailed quote", options: ["Calculate approximate cost", "Read tips about renovations", "Schedule an estimate", "Watch videos of previous jobs"], answer: "Schedule an estimate", explanation: "ハイライト部分に「見積もり担当者との相談を予約する」と記載されています。" },

            // Lesson 4: TODAY's TARGET TEST
            { id: 'l4-t-1', lesson: 'l4-target', text: "The sales manager was so busy with work ___ he did not have time to read the pile of reports on his desk.", options: ["it", "that", "this", "what"], answer: "that", explanation: "「とても〜なので…」という意味の 'so...that' 構文が適切です。" },
            { id: 'l4-t-2', lesson: 'l4-target', text: "It is strongly suggested that smoking and drinking ___ avoided during pregnancy.", options: ["are", "be", "were", "will be"], answer: "be", explanation: "「〜すべきである」という提案を表す構文で、動詞の原形 'be' が適切です。" },
            { id: 'l4-t-3', lesson: 'l4-target', text: "The trainer encouraged the athlete, saying that the ___ intense the exercise, the greater the amount of calories he will burn.", options: ["less", "little", "more", "much"], answer: "more", explanation: "「〜すればするほど、ますます…」という意味の 'the more..., the more...' 構文が適切です。" },
            { id: 'l4-t-4', lesson: 'l4-target', text: "UPB Company has continued its shipping business not only domestically ___ internationally as well since the early 1990s.", options: ["and", "but", "nor", "or"], answer: "but", explanation: "「〜だけでなく…も」という意味の 'not only...but also...' 構文が適切です。" },
            { id: 'l4-t-5', lesson: 'l4-target', text: "Governor Rebecca Thornton claimed that she had her reputation ___ by the magazine article.", options: ["damage", "damaged", "damages", "damaging"], answer: "damaged", explanation: "「〜を…させる」という使役動詞 'had' の後に、目的語が「〜される」という意味になる過去分詞 'damaged' が適切です。" },
            { id: 'l4-t-6', lesson: 'l4-target', text: "Despite widespread media speculation, both companies have ___ to make an official announcement on the merger.", options: ["already", "even", "just", "yet"], answer: "yet", explanation: "否定文で「まだ〜していない」という意味の 'yet' が適切です。" },
            { id: 'l4-t-7', lesson: 'l4-target', text: "In order to reduce the deficit, the company will either have to decrease spending ___ increase product prices.", options: ["and", "nor", "or", "to"], answer: "or", explanation: "「〜か、それとも…か」という意味の 'either...or...' 構文が適切です。" },
            { id: 'l4-t-8', lesson: 'l4-target', text: "Ms. Drakes has had a lot of trouble ___ her van into the garage since she moved to a smaller house.", options: ["backing", "of backing", "to back", "when backs"], answer: "backing", explanation: "「〜するのに苦労する」という意味の 'have trouble doing' が適切です。" },
            { id: 'l4-t-9', lesson: 'l4-target', text: "Jenna Cox has to find someone who can translate the legal documents ___ French immediately.", options: ["for", "into", "through", "with"], answer: "into", explanation: "「〜に翻訳する」という意味の 'translate into' が適切です。" },
            { id: 'l4-t-10', lesson: 'l4-target', text: "There is no cancellation fee, ___ that it is requested more than 60 days before the departure of the tour.", options: ["provide", "provided", "provides", "to provide"], answer: "provided", explanation: "「〜という条件で」という意味の接続詞 'provided that' が適切です。" },
            { id: 'l4-t-11', lesson: 'l4-target', text: "We have not gotten a reply from three of the board members yet, as ___ as I know.", options: ["far", "long", "soon", "well"], answer: "far", explanation: "「私の知る限りでは」という意味の 'as far as I know' が適切です。" },
            { id: 'l4-t-12', lesson: 'l4-target', text: "This printing company was named ___ a famous mountain in its founder's birthplace.", options: ["after", "by", "in", "on"], answer: "after", explanation: "「〜にちなんで名付けられる」という意味の 'named after' が適切です。" },
            { id: 'l4-t-13', lesson: 'l4-target', text: "Dr. Norton felt it very difficult to make ___ understood when he made a speech in the Asian country.", options: ["he", "him", "himself", "his"], answer: "himself", explanation: "「自分自身を理解させる」という意味で再帰代名詞 'himself' が適切です。" },
            { id: 'l4-t-14', lesson: 'l4-target', text: "AT Communications makes no guarantees and accepts neither responsibility ___ liability regarding the security of any data set using the service.", options: ["and", "but", "nor", "or"], answer: "nor", explanation: "「〜も…もない」という意味の 'neither...nor...' 構文が適切です。" },
            { id: 'l4-t-15', lesson: 'l4-target', text: "Because his report was due today, Chad Anderson had his colleague ___ him with it.", options: ["help", "helped", "helping", "to help"], answer: "help", explanation: "使役動詞 'had' の後に動詞の原形 'help' が適切です。" },
            { id: 'l4-t-16', lesson: 'l4-target', text: "The medical companies can do nothing ___ reduce the price of the medicine because much cheaper medicine is being imported from developing countries.", options: ["alone", "but", "only", "sole"], answer: "but", explanation: "「〜するしかない」という意味の 'do nothing but' が適切です。" },

            // Lesson 4: Review Quiz
            { id: 'l4-r-1', lesson: 'l4-review', text: "E-mail usage is ___ common these days that people are surprised when they receive a real letter.", options: ["so", "such", "still", "very"], answer: "so", explanation: "「とても〜なので…」という意味の 'so...that' 構文が適切です。" },
            { id: 'l4-r-2', lesson: 'l4-review', text: "After the son rearranged his room, the mother made a suggestion that the desk and the chair ___ moved to face the window.", options: ["are", "be", "were", "would be"], answer: "be", explanation: "「〜すべきである」という提案を表す構文で、動詞の原形 'be' が適切です。" },
            { id: 'l4-r-3', lesson: 'l4-review', text: "Some economists say that the more brand-oriented a company is, the ___ profitable it is.", options: ["best", "largest", "more", "most"], answer: "more", explanation: "「〜すればするほど、ますます…」という意味の 'the more..., the more...' 構文が適切です。" },
            { id: 'l4-r-4', lesson: 'l4-review', text: "The telecommunications giant not only ___ the stock market downswing, but actually turned a profit during that unstable period.", options: ["had been survived", "survived", "surviving", "was surviving"], answer: "survived", explanation: "「〜だけでなく…も」という意味の 'not only...but also...' 構文で、動詞の過去形 'survived' が適切です。" },
            { id: 'l4-r-5', lesson: 'l4-review', text: "The official name of the new planet that was discovered last month has ___ to be determined.", options: ["already", "even", "just", "yet"], answer: "yet", explanation: "否定文で「まだ〜していない」という意味の 'yet' が適切です。" },
            { id: 'l4-r-6', lesson: 'l4-review', text: "The Mason City Library welcomes book requests; please submit your requests ___ in writing or by e-mail.", options: ["also", "both", "either", "neither"], answer: "either", explanation: "「〜か、それとも…か」という意味の 'either...or...' 構文が適切です。" },
            { id: 'l4-r-7', lesson: 'l4-review', text: "No matter ___ happens, the company head believes that his management philosophy will never change.", options: ["how", "what", "whatever", "when"], answer: "what", explanation: "「何が起ころうとも」という意味の 'no matter what' が適切です。" },
            { id: 'l4-r-8', lesson: 'l4-review', text: "This webpage shows you a very easy way to combine audio ___ pictures to make a video.", options: ["and", "for", "in", "or"], answer: "and", explanation: "2つの要素を並列につなぐ接続詞 'and' が適切です。" },

            // Lesson 5: TODAY's TARGET TEST
            { id: 'l5-t-1', lesson: 'l5-target', longText: "A Fantastic Event: The Transportation Expo\n\nThe Transportation Expo takes visitors on a tour of the past and present of transport and even gives them an awe-inspiring glimpse into the future. The event is on now through the end of October at the Centennial Convention Center. The Metropolitan History Association is one of the event's sponsors as ___ as an exhibitor.", text: "1. The Metropolitan History Association is one of the event's sponsors as ___ as an exhibitor.", highlightText: "sponsors as ___ as an exhibitor", options: ["many", "much", "soon", "well"], answer: "well", explanation: "「〜と同様に」という意味のフレーズ 'as well as' が適切です。" },
            { id: 'l5-t-2', lesson: 'l5-target', longText: "There is ___ much to see and do at the Expo to write it all here, but I have to mention the MHA exhibit. This amazing interactive trip through the history of public transportation has equal appeal to kids and kids at heart. Don't miss it.", text: "2. There is ___ much to see and do at the Expo to write it all here...", highlightText: "There is ___ much to see and do", options: ["enough", "such", "too", "way"], answer: "too", explanation: "「〜すぎて…できない」という意味の 'too...to' 構文が適切です。" },
            { id: 'l5-t-3', lesson: 'l5-target', longText: "The Expo's hours are 10:00 am. to 6:00 p.m. daily, ___ for Mondays. Tickets are available at the door.", text: "3. The Expo's hours are 10:00 am. to 6:00 p.m. daily, ___ for Mondays.", highlightText: "daily, ___ for Mondays", options: ["according", "except", "only", "whereas"], answer: "except", explanation: "「〜を除いて」という意味の 'except for' が適切です。" },
            { id: 'l5-t-4', lesson: 'l5-target', longText: "Dear Mr. Cornwell,\n\nThank you for your e-mail informing us that you have not received your shipment of glasses. I apologize for the delay. ___ you may know, we use a special type of carton to ensure our products arrive intact.", text: "4. ___ you may know, we use a special type of carton...", highlightText: "___ you may know", options: ["As", "For", "Though", "While"], answer: "As", explanation: "「ご存じのように」という意味のフレーズ 'As you may know' が適切です。" },
            { id: 'l5-t-5', lesson: 'l5-target', longText: "Unfortunately, due to a miscommunication with our supplier, the custom-made shipping cartons did not arrive as ___ last week. We did ship the glasses by overnight express mail today, so you should receive them tomorrow.", text: "5. ...the custom-made shipping cartons did not arrive as ___ last week.", highlightText: "arrive as ___ last week", options: ["expect", "expected", "expecting", "expects"], answer: "expected", explanation: "「期待された通りに」という意味で過去分詞 'expected' が適切です。" },
            { id: 'l5-t-6', lesson: 'l5-target', longText: "We regret the inconvenience this may have caused. We plan to keep an extra supply of our special cartons on hand to prevent this ___ happening in the future. As a token of our sincere appreciation for your business, I've included a coupon code at the bottom of this message.", text: "6. ...to prevent this ___ happening in the future.", highlightText: "prevent this ___ happening", options: ["along", "away", "from", "under"], answer: "from", explanation: "「〜が…するのを防ぐ」という意味の 'prevent A from doing' 構文が適切です。" },
            { id: 'l5-t-7', lesson: 'l5-target', longText: "To: All Salespeople\nRe: Annual Sales Event\n\nOur annual sales event begins next week on Monday, May 6. You are all authorized to ___ retail sales at prices down to ten percent above cost on items that have been in stock for more than one year.", text: "7. You are all authorized to ___ retail sales at prices down...", highlightText: "authorized to ___ retail sales", options: ["get", "help", "let", "make"], answer: "make", explanation: "「販売を行う」という意味のコロケーション 'make sales' が適切です。" },
            { id: 'l5-t-8', lesson: 'l5-target', longText: "Each item in stock has a date sticker on its packaging. Salespeople are encouraged to offer these deals in ___ to make room for incoming items.", text: "8. ...offer these deals in ___ to make room for incoming items.", highlightText: "deals in ___ to make room", options: ["answer", "order", "preference", "response"], answer: "order", explanation: "「〜するために」という意味のフレーズ 'in order to' が適切です。" },
            { id: 'l5-t-9', lesson: 'l5-target', longText: "This sale is highly anticipated by our customers. Though it is a busy week, it does a lot to guarantee customer loyalty, so do ___ best to make it a successful time for everyone. Thank you.", text: "9. ...so do ___ best to make it a successful time for everyone.", highlightText: "so do ___ best", options: ["another", "one's", "what", "your"], answer: "your", explanation: "「最善を尽くす」という意味のフレーズ 'do one's best' で、ここでは 'your best' が適切です。" },

            // Lesson 5: Review Quiz
            { id: 'l5-r-1', lesson: 'l5-review', longText: "Dear Ms. Addison,\n\n___ was very nice to meet you yesterday. I'm quite excited about the prospect of our companies working together in the future. I have attached a draft proposal for our joint presentation at my company's upcoming board meeting for your review and comment.", text: "1. ___ was very nice to meet you yesterday.", highlightText: "___ was very nice to meet you yesterday", options: ["I", "It", "That", "What"], answer: "It", explanation: "状況を表す主語として 'It' が適切です。" },
            { id: 'l5-r-2', lesson: 'l5-review', longText: "In addition to your comments, I'd appreciate your filling in some of the blanks in the proposal, such as your firm's sales figures ___ future product improvement ideas.", text: "2. ...your firm's sales figures ___ future product improvement ideas.", highlightText: "sales figures ___ future product", options: ["and", "but", "if", "so"], answer: "and", explanation: "2つの要素を並列につなぐ接続詞 'and' が適切です。" },
            { id: 'l5-r-3', lesson: 'l5-review', longText: "If you'd like to make any changes to my part of the presentation, I ___ be happy to discuss them with you. I'm available by phone any day this week after 4:00, or in person on Friday morning at 10:00.", text: "3. ...I ___ be happy to discuss them with you.", highlightText: "I ___ be happy to discuss them", options: ["can", "must", "should", "would"], answer: "would", explanation: "仮定法で「喜んで〜するでしょう」という意味の 'would be happy to' が適切です。" },
            { id: 'l5-r-4', lesson: 'l5-review', longText: "Dear Ms. Whitman,\n\nThank you for your interest in the position of reporter at our magazine. We have received your resume and writing samples, along ___ your cover letter.", text: "4. ...your resume and writing samples, along ___ your cover letter.", highlightText: "along ___ your cover letter", options: ["beside", "for", "on", "with"], answer: "with", explanation: "「〜と一緒に」という意味の 'along with' が適切です。" },
            { id: 'l5-r-5', lesson: 'l5-review', longText: "Since our features editor Mr. Wilson is out of the country at the moment, we are sorry to say that we will not be able to schedule an interview with you right away. However, I forwarded your resume and writing samples to him and he was ___ impressed with your writing that he would like to meet you...", text: "5. ...he was ___ impressed with your writing that he would like to meet you...", highlightText: "he was ___ impressed with your writing that", options: ["greatly", "much", "so", "very"], answer: "so", explanation: "「とても〜なので…」という意味の 'so...that' 構文が適切です。" },
            { id: 'l5-r-6', lesson: 'l5-review', longText: "...he would like to meet you as soon ___ he is back in town. I will call you at the number listed on your resume to set up an interview sometime during the week Mr. Wilson returns, July 22-26.", text: "6. ...as soon ___ he is back in town.", highlightText: "as soon ___ he is back", options: ["as", "before", "when", "while"], answer: "as", explanation: "「〜するとすぐに」という意味の 'as soon as' が適切です。" },
            
            // Lesson 6: TODAY's TARGET TEST
            { id: 'l6-t-1', lesson: 'l6-target', longText: "Expense Report-Northfield Aviation\nName: Mary O'Donnell\nDestination: Newburg, CA\nPurpose: Annual AES Conference\n...", text: "1. According to the report, what is one reason for Ms. O'Donnell's travel?", highlightText: "Purpose: Annual AES Conference", options: ["To give a presentation at an event", "To make an estimate for her project", "To recruit new employees", "To visit the Newburg Continental Hotel for inspections"], answer: "To give a presentation at an event", explanation: "報告書の「目的」欄に「Annual AES Conference」とあり、これは通常、発表を伴うイベントです。" },
            { id: 'l6-t-2', lesson: 'l6-target', longText: "Car rental: $200.00(2 days)", text: "2. What is NOT true about Ms. O'Donnell's travel?", highlightText: "Car rental: $200.00(2 days)", options: ["She drove a car every day.", "She flew to Newburg.", "She rented some equipment.", "She stayed at one hotel."], answer: "She drove a car every day.", explanation: "レンタカーは2日間と記載されており、毎日運転したとは限りません。他の選択肢は文脈から推測できます。" },
            { id: 'l6-t-3', lesson: 'l6-target', longText: "To: Sales Staff\nFrom: Nancy Colton\nRe: New Sales Guidelines\nWe are looking at some new guidelines for the sales teams. We have decided to place individual salespeople into teams of two to work the same districts together. We feel that the teams can combine their clients and make more sales working together. This will also allow clients to have more than one contact with the company, allowing them to speak with their salesperson more easily.", text: "3. What does Ms. Colton believe is a benefit of the new policy?", highlightText: "This will also allow clients to have more than one contact with the company, allowing them to speak with their salesperson more easily.", options: ["Clients can more easily get in touch with the company.", "Newer workers will learn a lot from veterans.", "Operating expenses will be saved.", "Staff will get to know their products better."], answer: "Clients can more easily get in touch with the company.", explanation: "ハイライト部分に「顧客が会社と複数の接点を持つことができ、営業担当者とより簡単に話せるようになる」と記載されています。" },
            { id: 'l6-t-4', lesson: 'l6-target', longText: "I have included a list of the two-person teams we have chosen to work together with this memo. We based these decisions on several factors including: proximity of their sales districts, experience and sales numbers for each staff member. If you have concerns about the team to which you've been assigned, please take it up with Luis Valdez. He will be the main contact for each team.", text: "4. What information can one get from the attachment to the memo?", highlightText: "I have included a list of the two-person teams we have chosen to work together", options: ["All the names of the company's clients", "The areas the new teams will cover", "The list of the company's new products", "The name of the person he/she will work with"], answer: "The name of the person he/she will work with", explanation: "メモには「2人組のチームのリスト」が添付されていると記載されています。" },
            { id: 'l6-t-5', lesson: 'l6-target', longText: "Weston Community Center Room Reservation Form\nNAME: Hugo Austen\nREQUESTED DATE/TIME: June 17, 2:00-4:00 p.m.\nPURPOSE OF EVENT: Volunteer association general meeting\nPlease put an X beside your requested room:\nRoom C ($60/hr., max, capacity: 50)  X", text: "5. What is true of Mr. Austen's reservation?", highlightText: "Room C ($60/hr., max, capacity: 50)  X", options: ["Fewer than 50 people will attend his event.", "His event will last for 3 hours.", "His event will take place in the morning.", "It will cost $150 for his requested room."], answer: "Fewer than 50 people will attend his event.", explanation: "部屋Cの最大収容人数が50人であり、会議の目的から通常はそれ以下と推測されます。" },
            { id: 'l6-t-6', lesson: 'l6-target', longText: "TERMS AND CONDITIONS:\n- Cancellations must be made in person at the Weston Community Center Main office.", text: "6. What should Mr. Austen do if he needs to cancel his reservation?", highlightText: "Cancellations must be made in person at the Weston Community Center Main office.", options: ["Fill out a request form online.", "Go to the community center himself.", "Make a phone call the day before the event.", "Send an e-mail to the reservation office."], answer: "Go to the community center himself.", explanation: "ハイライト部分に「キャンセルはウェストンコミュニティセンター本事務所で直接行う必要がある」と記載されています。" },

            // Lesson 6: Review Quiz
            { id: 'l6-r-1', lesson: 'l6-review', longText: "Application for Leave\nPlease fill out the following form and file it with Louise Walden in human resources two weeks prior to the date requested. You must have the approval of your immediate supervisor before filing a request.\nApplication Date: February 20\nDate(s): February 18-21", text: "1. When should Ms. Walker have submitted the application?", highlightText: "two weeks prior to the date requested", options: ["By mid-January", "By the end of January", "By early February", "By mid-February"], answer: "By early February", explanation: "申請日は2月20日で、申請の2週間前までに提出する必要があるため、2月初旬が適切です。" },
            { id: 'l6-r-2', lesson: 'l6-review', longText: "Immediate supervisor: Raul Mendoza\nSignature of immediate supervisor: ________", text: "2. Who should check the application next?", highlightText: "Signature of immediate supervisor:", options: ["Judy Walker", "Louise Walden", "Raul Mendoza", "The human resources department head"], answer: "Raul Mendoza", explanation: "直属の上司の署名が必要であり、直属の上司はRaul Mendozaです。" },
            { id: 'l6-r-3', lesson: 'l6-review', longText: "To: All Customer Service Staff\nFrom: Mike Chang, Customer Service Supervisor\nNext Wednesday we'll be having some visitors to the call center. As you know, our company has recently merged with Wireworks. Due to our superior customer service record, Wireworks would like to model their customer service call centers across the country on our department.", text: "3. Why are the Wireworks directors visiting Mike Chang's department?", highlightText: "Wireworks would like to model their customer service call centers across the country on our department.", options: ["They are being introduced to their new co-workers.", "They are interviewing potential candidates for new positions.", "They are looking for ways to improve it.", "They want to find out how the employees do their jobs."], answer: "They want to find out how the employees do their jobs.", explanation: "ハイライト部分に「Wireworksは、彼らのカスタマーサービスコールセンターを私たちの部署をモデルにしたい」と記載されています。これは、私たちの部署がどのように機能しているかを知るためです。" },
            { id: 'l6-r-4', lesson: 'l6-review', longText: "Directors from Wirework will be on-site all day to study how we do things. Some of them may want to ask you questions about how you handle different situations. Some of you may be taken off the call center floor to a meeting room for a short interview about different aspects of the job.", text: "4. Where will the Wireworks directors spend most of their time next Wednesday?", highlightText: "on-site all day to study how we do things", options: ["At The call center", "In a meeting room", "In a reception room", "In the company cafeteria"], answer: "At The call center", explanation: "ハイライト部分に「終日現場で私たちのやり方を研究する」と記載されており、コールセンターがその現場です。" },

            // Lesson 7: TODAY's TARGET TEST
            { id: 'l7-t-1', lesson: 'l7-target', text: "According to the carmaker's CEO, in ten years, electric cars ___ ten percent of the overall global automobile sales.", options: ["has represented", "represent", "represented", "will represent"], answer: "will represent", explanation: "「10年後には」という未来の時点を表すため、未来形 'will represent' が適切です。" },
            { id: 'l7-t-2', lesson: 'l7-target', text: "The sales department usually has an all staff meeting once a month, but it ___ three meetings so far this month.", options: ["has", "has had", "is having", "will have"], answer: "has had", explanation: "「今月これまでに」という現在までの完了を表すため、現在完了形 'has had' が適切です。" },
            { id: 'l7-t-3', lesson: 'l7-target', text: "Mark Taylor ___ his father for three years when he died of a heart attack at the age of 50.", options: ["did not see", "had not seen", "have not seen", "was not seeing"], answer: "had not seen", explanation: "過去の特定の時点（彼が亡くなった時）までに完了していた行動を表すため、過去完了形 'had not seen' が適切です。" },
            { id: 'l7-t-4', lesson: 'l7-target', text: "Much to his surprise, Jim Harris realized that by the end of this year, he ___ in Tokyo for ten years.", options: ["has lived", "lives", "will have lived", "will live"], answer: "will have lived", explanation: "今年の終わりまでに完了する行動を表すため、未来完了形 'will have lived' が適切です。" },
            { id: 'l7-t-5', lesson: 'l7-target', text: "Mike Foster ___ Mr. Roberts as a family friend ever since he was old enough to talk.", options: ["has known", "knew", "knows", "would know"], answer: "has known", explanation: "過去から現在まで続いている状態を表すため、現在完了形 'has known' が適切です。" },
            { id: 'l7-t-6', lesson: 'l7-target', text: "The store will be closed temporarily until fire investigators ___ their inquiry and safety checks.", options: ["complete", "completed", "had completed", "would complete"], answer: "complete", explanation: "「〜するまで」という未来の時点を表す 'until' の後では、現在形 'complete' が未来の意味を表します。" },
            { id: 'l7-t-7', lesson: 'l7-target', text: "This e-mail is to inform you that the new payroll system ___ into effect on April 1st.", options: ["come", "had come", "will come", "would have come"], answer: "will come", explanation: "「4月1日に発効する」という未来の出来事を表すため、未来形 'will come' が適切です。" },
            { id: 'l7-t-8', lesson: 'l7-target', text: "Ken Cox ___ for tomorrow's presentation the whole afternoon, and he does not know how much longer it will take.", options: ["has been preparing", "has prepared", "prepares", "will prepare"], answer: "has been preparing", explanation: "午後中ずっと準備しており、それが現在も続いていることを表すため、現在完了進行形 'has been preparing' が適切です。" },
            { id: 'l7-t-9', lesson: 'l7-target', text: "Judging from her previous works, city officials thought that the architect ___ perfect for designing the new city hall.", options: ["has been", "is", "will be", "would be"], answer: "would be", explanation: "過去の判断に基づいて、現在（または未来）の状況がどうであろうかという仮定を表すため、仮定法過去の 'would be' が適切です。" },
            { id: 'l7-t-10', lesson: 'l7-target', text: "Several news sources report that Zymal, Inc. and Primal Techs ___ secret talks about a merger in the near future.", options: ["are conducting", "conduct", "had conducted", "will be conducted"], answer: "are conducting", explanation: "「近い将来に〜している」という進行中の未来の計画を表すため、現在進行形 'are conducting' が適切です。" },
            { id: 'l7-t-11', lesson: 'l7-target', text: "Tim Damon ___ piano lessons for three years until he broke his wrist falling down the stairs.", options: ["had been taking", "has been taking", "takes", "would take"], answer: "had been taking", explanation: "過去の特定の時点（手首を骨折するまで）まで続いていた行動を表すため、過去完了進行形 'had been taking' が適切です。" },
            { id: 'l7-t-12', lesson: 'l7-target', text: "Richard Tyson ___ around in the woods near his house with his dog every morning.", options: ["had walked", "is walking", "walks", "would have walked"], answer: "walks", explanation: "毎朝行われる習慣的な行動を表すため、現在形 'walks' が適切です。" },
            { id: 'l7-t-13', lesson: 'l7-target', text: "Ryan Ashton ___ working for the company for exactly 30 years next week.", options: ["has been", "is", "will be", "will have been"], answer: "will have been", explanation: "来週の特定の時点までに完了する（30年になる）行動を表すため、未来完了進行形 'will have been' が適切です。" },
            { id: 'l7-t-14', lesson: 'l7-target', text: "The daughter made a phone call to her home; otherwise her parents ___ about her.", options: ["had worried", "worry", "worried", "would have worried"], answer: "would have worried", explanation: "「そうでなければ（もし電話しなかったら）、〜していただろう」という過去の仮定を表すため、仮定法過去完了の 'would have worried' が適切です。" },
            { id: 'l7-t-15', lesson: 'l7-target', text: "This letter is to notify you that you ___ for an annual comprehensive medical examination.", options: ["had been scheduled", "have been scheduled", "schedule", "scheduled"], answer: "have been scheduled", explanation: "「〜が予定されている」という現在までの完了した受動態を表すため、現在完了受動態 'have been scheduled' が適切です。" },
            { id: 'l7-t-16', lesson: 'l7-target', text: "If you're looking for a dentist, call CHJ Dental Center right away and you ___ glad you did.", options: ["are", "have been", "will be", "were"], answer: "will be", explanation: "未来の結果を表すため、未来形 'will be' が適切です。" },

            // Lesson 7: Review Quiz
            { id: 'l7-r-1', lesson: 'l7-review', text: "An inspection team from the company headquarters ___ at the airport later this afternoon.", options: ["arrive", "arrived", "had arrived", "will arrive"], answer: "will arrive", explanation: "「今日の午後遅くに」という未来の出来事を表すため、未来形 'will arrive' が適切です。" },
            { id: 'l7-r-2', lesson: 'l7-review', text: "Miyuki Tyson ___ as a criminal lawyer specializing in youth crimes in Las Vegas since the mid-1980s.", options: ["has been working", "will work", "worked", "works"], answer: "has been working", explanation: "1980年代半ばから現在まで続いている行動を表すため、現在完了進行形 'has been working' が適切です。" },
            { id: 'l7-r-3', lesson: 'l7-review', text: "The sales meeting ___ for tomorrow, but the manager rescheduled it to next Monday due to a sudden business trip.", options: ["had been scheduled", "has been scheduled", "is scheduled", "would be scheduled"], answer: "had been scheduled", explanation: "マネージャーが再スケジュールする前に、会議が「明日に予定されていた」という過去の完了を表すため、過去完了受動態 'had been scheduled' が適切です。" },
            { id: 'l7-r-4', lesson: 'l7-review', text: "The medical analyst's controversial prediction was that all viruses ___ in the future.", options: ["eliminated", "has eliminated", "was eliminated", "would be eliminated"], answer: "would be eliminated", explanation: "過去の予測で、未来の受動的な結果を表すため、 'would be eliminated' が適切です。" },
            { id: 'l7-r-5', lesson: 'l7-review', text: "The annual convention of the American Psychological Association ___ held at Hotel Orion now.", options: ["is being", "had been", "was", "will be"], answer: "is being", explanation: "「現在開催されている」という進行中の受動態を表すため、現在進行受動態 'is being' が適切です。" },
            { id: 'l7-r-6', lesson: 'l7-review', text: "Even though I complain a lot about Brian, he is the best assistant I ___ in my ten years as manager.", options: ["have", "had", "have had", "will have had"], answer: "have had", explanation: "マネージャーとしての10年間で「持ったことがある」という経験を表すため、現在完了形 'have had' が適切です。" },
            { id: 'l7-r-7', lesson: 'l7-review', text: "According to the survey, more than 70 percent of high school students ___ before they were 15 years old.", options: ["had been smoking", "had smoked", "have been smoking", "smoke"], answer: "had smoked", explanation: "15歳になる「前に」完了していた行動を表すため、過去完了形 'had smoked' が適切です。" },
            { id: 'l7-r-8', lesson: 'l7-review', text: "SOV Communications ___ a merger negotiation with Livable, Inc. by the end of the month.", options: ["concluded", "has concluded", "were concluded", "will have concluded"], answer: "will have concluded", explanation: "今月末までに完了する行動を表すため、未来完了形 'will have concluded' が適切です。" },

            // Lesson 8: TODAY's TARGET TEST
            { id: 'l8-t-1', lesson: 'l8-target', longText: "CAMPUS PARKING SUSPENDED OVER SPRING BREAK\n\nTo allow for the resurfacing of the campus parking lots, parking will be suspended for all students and faculty members for the duration of spring break. If you ___ to come to campus during this time, please use public transport or use the parking lot at City Hall.", text: "1. If you ___ to come to campus during this time...", highlightText: "If you ___ to come to campus", options: ["have needed", "need", "needed", "will have needed"], answer: "need", explanation: "現在の状況を表す動詞の原形 'need' が適切です。" },
            { id: 'l8-t-2', lesson: 'l8-target', longText: "We understand that this ___ inconvenience and are offering all affected users a 10% refund of the cost of their parking permits.", text: "2. We understand that this ___ inconvenience...", highlightText: "this ___ inconvenience", options: ["causes", "causing", "has caused", "will cause"], answer: "will cause", explanation: "将来の不便さを表す未来形 'will cause' が適切です。" },
            { id: 'l8-t-3', lesson: 'l8-target', longText: "Please visit the main campus office in the McDonald building to receive an application form. We apologize again for the inconvenience, but ___ that you will be pleased with the improvements place on our campus.", text: "3. ...but ___ that you will be pleased...", highlightText: "but ___ that you will be pleased", options: ["have hoped", "hope", "hoped", "were hoping"], answer: "hope", explanation: "現在の希望を表す動詞の原形 'hope' が適切です。" },
            { id: 'l8-t-4', lesson: 'l8-target', longText: "The importance of SEO (search engine optimization) in today's competitive online world cannot be overlooked. In order to get search engines to rank your page highly in search results and drive customers to your site, you ___ to learn how to appeal to their algorithms.", text: "4. ...you ___ to learn how to appeal to their algorithms.", highlightText: "you ___ to learn how", options: ["had", "have", "have had", "will have had"], answer: "have", explanation: "「〜する必要がある」という意味の 'have to' が適切です。" },
            { id: 'l8-t-5', lesson: 'l8-target', longText: "First, check your keywords. Are you using terms that clearly ___ to your content or products? Look at the websites of your competitors and see what you can learn from them.", text: "5. Are you using terms that clearly ___ to your content or products?", highlightText: "terms that clearly ___ to your content", options: ["are relating", "relate", "related", "to relate"], answer: "relate", explanation: "「〜に関連する」という意味の動詞の原形 'relate' が適切です。" },
            { id: 'l8-t-6', lesson: 'l8-target', longText: "But be careful, overuse of keywords can flag the page as spam and it may be ignored by search engines completely. Finally, make sure that your website ___ up to date and refreshed regularly to ensure that it stays relevant...", text: "6. ...make sure that your website ___ up to date...", highlightText: "website ___ up to date", options: ["is kept", "keeps", "was kept", "will be keeping"], answer: "is kept", explanation: "「〜が保たれる」という受動態の 'is kept' が適切です。" },
            { id: 'l8-t-7', lesson: 'l8-target', longText: "Dear Ms. Campbell,\n\nThis is Matthias Muller. It was a pleasure to meet you at the Business Skills seminar the other day. I found your presentation very informative... As discussed, I ___ my résumé and have attached it to this e-mail for your review.", text: "7. As discussed, I ___ my résumé and have attached it...", highlightText: "I ___ my résumé and have attached it", options: ["have refresh", "have refreshed", "refresh", "will refresh"], answer: "have refreshed", explanation: "「履歴書を更新した」という完了を表す現在完了形 'have refreshed' が適切です。" },
            { id: 'l8-t-8', lesson: 'l8-target', longText: "I appreciate your offer to look it over and offer me some pointers about how to tailor it for the marketing position at InnoviCraft. I think that the experience I ___ in my current position will make my application stand out...", text: "8. ...the experience I ___ in my current position...", highlightText: "experience I ___ in my current position", options: ["gaining", "gains", "have gained", "will gain"], answer: "have gained", explanation: "現在までの経験を表す現在完了形 'have gained' が適切です。" },
            { id: 'l8-t-9', lesson: 'l8-target', longText: "If you could help me in this area in particular, I ___ extremely grateful. Thank you again for taking the time to help me. I know that you are very busy!", text: "9. If you could help me in this area in particular, I ___ extremely grateful.", highlightText: "I ___ extremely grateful", options: ["am", "have been", "was", "would be"], answer: "would be", explanation: "仮定法で「〜ならば、非常に感謝するでしょう」という意味の 'would be' が適切です。" },

            // Lesson 8: Review Quiz
            { id: 'l8-r-1', lesson: 'l8-review', longText: "Are you drinking enough water? People who stay well-hydrated ___ to develop fewer chronic conditions, be overall healthier, and live longer than those who may not have enough intake of fluids, according to a study published recently in scientific journal SciNow.", text: "1. People who stay well-hydrated ___ to develop fewer chronic conditions...", highlightText: "well-hydrated ___ to develop", options: ["appear", "appeared", "were appearing", "will appear"], answer: "appear", explanation: "「〜のようだ」という意味の動詞の原形 'appear' が適切です。" },
            { id: 'l8-r-2', lesson: 'l8-review', longText: "Over a 20-year period, researchers analyzed data gathered from over 10,000 adults to examine the link between sodium levels... and various health indicators. It ___ that adults with higher than normal sodium levels were more likely to develop chronic conditions...", text: "2. It ___ that adults with higher than normal sodium levels...", highlightText: "It ___ that adults", options: ["find", "found", "is finding", "was found"], answer: "was found", explanation: "「〜と判明した」という受動態の 'was found' が適切です。" },
            { id: 'l8-r-3', lesson: 'l8-review', longText: "'The results suggest that proper hydration may slow down aging and ___ a disease-free life,' stated lead researcher Man Lim.", text: "3. '...proper hydration may slow down aging and ___ a disease-free life,'...", highlightText: "and ___ a disease-free life", options: ["could prolong", "did prolong", "is prolonging", "will have prolonged"], answer: "could prolong", explanation: "「〜する可能性がある」という意味で助動詞 'could' と動詞の原形 'prolong' が適切です。" },

            // Lesson 9: TODAY's TARGET TEST
            { id: 'l9-t-1', lesson: 'l9-target', longText: "I wanted to personally thank you for the article you wrote in the January issue of Dining Digest about our restaurant here in Mission Valley. Fortuna has been open just over a year, and while we have been unusually successful for a new business, the additional exposure your article gave us has made this past month our busiest yet.", text: "1. How did the article affect Marco's business?", highlightText: "the additional exposure your article gave us has made this past month our busiest yet", options: ["It drew attention to a certain dish.", "It had little effect.", "It increased customers.", "It inspired a new business idea."], answer: "It increased customers.", explanation: "ハイライト部分に「この記事が過去1ヶ月で最も忙しい月になった」と記載されており、これは顧客が増えたことを意味します。" },
            { id: 'l9-t-2', lesson: 'l9-target', longText: "I especially appreciated the attention you gave to our head chef, Jennifer Winston, she is very talented and deserves recognition for what she is doing with traditional Italian food here.", text: "2. Who was mentioned specifically in the article?", highlightText: "the attention you gave to our head chef, Jennifer Winston", options: ["Fortuna's head chef", "Marco's family", "The owner of Fortuna", "Thomas Cooper"], answer: "Fortuna's head chef", explanation: "ハイライト部分に「ヘッドシェフのジェニファー・ウィンストンに注目してくれたことに感謝する」と記載されています。" },
            { id: 'l9-t-3', lesson: 'l9-target', longText: "We have plans to start a smaller cafe next door to Fortuna next year. It will feature a bakery and deli and offer lunch and smaller meals, similar to a small cafe you would find in Italy.", text: "3. What will Marco do in the near future?", highlightText: "We have plans to start a smaller cafe next door to Fortuna next year.", options: ["Expand his business in the area", "Go to Italy to find a new chef", "Remodel his restaurant", "Write an article in Dining Digest"], answer: "Expand his business in the area", explanation: "ハイライト部分に「来年フォルトゥーナの隣に小さなカフェを始める計画がある」と記載されており、これは事業拡大を意味します。" },
            { id: 'l9-t-4', lesson: 'l9-target', longText: "Dear Ms. Littleton,\n\nThank you again for agreeing to take part in our series of interviews with people working in cutting-edge scientific fields. Juliet Carlisle passed your contact information to me as I will be conducting your interview. I understand that you are available on the morning of May 22 and would like to suggest your lab as the location for your interview, if that is convenient for you.", text: "4. What is the main purpose of the e-mail?", highlightText: "I will be conducting your interview. I understand that you are available on the morning of May 22", options: ["To agree to a request to take part in an interview", "To ask someone to write about a famous scientist", "To inform someone of a schedule change", "To provide information for an upcoming meeting"], answer: "To provide information for an upcoming meeting", explanation: "メールは面接の日程と場所について情報を提供しています。" },
            { id: 'l9-t-5', lesson: 'l9-target', longText: "I understand that you are available on the morning of May 22 and would like to suggest your lab as the location for your interview, if that is convenient for you. It would allow me to get a closer look at your work and would also be good for photographs.", text: "5. Where would Mr. Linus like meet Ms. Littleton?", highlightText: "suggest your lab as the location for your interview", options: ["In a coffee shop", "In a factory", "In a laboratory", "In an office"], answer: "In a laboratory", explanation: "ハイライト部分に「面接の場所としてあなたの研究室を提案したい」と記載されています。" },
            { id: 'l9-t-6', lesson: 'l9-target', longText: "When we meet, I will ask a series of questions. I will list them below in case you would like to look them over in advance.\n- What is your educational background, and how did it lead you to your current field of study?\n- Who or what inspires you to pursue this work?\n- Have you faced any challenges or setbacks in your work, and how have you overcome them?\n- Will you continue to work in this field, or would you like to move in another direction?", text: "6. What will Mr. Linus NOT mention during their meeting?", highlightText: "What is your educational background... Who or what inspires you... Have you faced any challenges... Will you continue to work...", options: ["Ms. Littleton's hobbies and interests", "Ms. Littleton's inspiration for her work", "Ms. Littleton's plans for the future", "Ms. Littleton's problems at work"], answer: "Ms. Littleton's hobbies and interests", explanation: "質問リストには、教育背景、インスピレーション、課題、将来の計画が含まれていますが、趣味や興味については言及されていません。" },

            // Lesson 9: Review Quiz
            { id: 'l9-r-1', lesson: 'l9-review', longText: "I was delighted that the engineering section agreed with me that you were the perfect candidate for the software engineering position. They've been short of a person for several months, so I know they are anxiously awaiting your arrival.", text: "1. What is mentioned about the engineers?", highlightText: "They've been short of a person for several months", options: ["They're hosting a conference.", "They're losing some co-workers soon.", "They've been given an award.", "They've been overloaded with work."], answer: "They've been overloaded with work.", explanation: "ハイライト部分に「数ヶ月間人手が足りなかった」と記載されており、これは仕事が多すぎたことを意味します。" },
            { id: 'l9-r-2', lesson: 'l9-review', longText: "Speaking of which, your orientation is scheduled for the morning of October 29th, as you know from the packet of materials my assistant Sterling Banks sent you last week.", text: "2. Who is Sterling Banks?", highlightText: "my assistant Sterling Banks sent you", options: ["A company president", "A human resource executive", "An engineer", "An executive assistant"], answer: "An executive assistant", explanation: "ハイライト部分に「私のアシスタント、スターリング・バンクス」と記載されています。" },
            { id: 'l9-r-3', lesson: 'l9-review', longText: "Please bring the completed bank and insurance forms with you on that day. What was not included in those materials was an invitation to an informal welcome party...", text: "3. What should Mr. Tupak bring on October 29th?", highlightText: "Please bring the completed bank and insurance forms with you", options: ["His design ideas", "His resume", "Some paperwork", "Some references"], answer: "Some paperwork", explanation: "ハイライト部分に「記入済みの銀行と保険の書類を持ってきてください」と記載されています。" },

            // Lesson 10: TODAY's TARGET TEST
            { id: 'l10-t-1', lesson: 'l10-target', text: "The president said that his plan would result ___ a budget cut of one billion yen.", options: ["from", "in", "of", "with"], answer: "in", explanation: "「〜という結果になる」という意味の 'result in' が適切です。" },
            { id: 'l10-t-2', lesson: 'l10-target', text: "Customers should pay invoices ___ 7 days after receipt of goods to avoid late-payment fees.", options: ["for", "since", "until", "within"], answer: "within", explanation: "「〜以内に」という意味の 'within' が適切です。" },
            { id: 'l10-t-3', lesson: 'l10-target', text: "It is expected that staff will stay late as needed ___ the company's busy end of year period.", options: ["between", "during", "for", "until"], answer: "during", explanation: "特定の期間中に」という意味の 'during' が適切です。" },
            { id: 'l10-t-4', lesson: 'l10-target', text: "The CEO met with his advisers ___ lunch to discuss the issue in more detail.", options: ["by", "lest", "over", "while"], answer: "over", explanation: "「〜しながら」という意味で、食事をしながらの会話を表す 'over' が適切です。" },
            { id: 'l10-t-5', lesson: 'l10-target', text: "Olivia Roberts and Kevin Paulson were ___ those nominated for the Business Leader of the Year award.", options: ["among", "between", "like", "neither"], answer: "among", explanation: "3人以上の間で」という意味の 'among' が適切です。" },
            { id: 'l10-t-6', lesson: 'l10-target', text: "Eddie Vance has to find someone who can translate the legal documents ___ Spanish immediately.", options: ["between", "for", "into", "with"], answer: "into", explanation: "「〜に翻訳する」という意味の 'translate into' が適切です。" },
            { id: 'l10-t-7', lesson: 'l10-target', text: "The sales manager was glad that she took the seminar because it went far ___ her expectation.", options: ["across", "beyond", "over", "within"], answer: "beyond", explanation: "「〜を超えて」という意味の 'beyond' が適切です。" },
            { id: 'l10-t-8', lesson: 'l10-target', text: "If you do not respond ___ the due date indicated above, we will have to take legal action.", options: ["after", "by", "through", "until"], answer: "by", explanation: "「〜までに」という意味の 'by' が適切です。" },
            { id: 'l10-t-9', lesson: 'l10-target', text: "The document shows that average tuition at public schools has increased ___ 15 percent over the past few years.", options: ["at", "by", "for", "to"], answer: "by", explanation: "「〜だけ増加する」という意味の 'increase by' が適切です。" },
            { id: 'l10-t-10', lesson: 'l10-target', text: "According to the attorney, his services become necessary when the situation calls ___ a professional legal judgment.", options: ["as", "for", "if", "off"], answer: "for", explanation: "「〜を要求する」という意味の 'call for' が適切です。" },
            { id: 'l10-t-11', lesson: 'l10-target', text: "Please click here to jump to the page ___ which detailed information about our activities can be found.", options: ["at", "in", "on", "with"], answer: "on", explanation: "「ページ上に」という意味の 'on the page' が適切です。" },
            { id: 'l10-t-12', lesson: 'l10-target', text: "Please inform us ___ your flight number and arrival time so that we can pick you up at the airport.", options: ["for", "of", "to", "with"], answer: "of", explanation: "「〜について知らせる」という意味の 'inform of' が適切です。" },
            { id: 'l10-t-13', lesson: 'l10-target', text: "Techsupply.com sells used computers ___ very reasonable prices and usually offers one-year warranties.", options: ["at", "by", "in", "on"], answer: "at", explanation: "価格を表す前置詞 'at' が適切です。" },
            { id: 'l10-t-14', lesson: 'l10-target', text: "Ms. Young argued strongly for the change to be made, but everyone else on her team was ___ it.", options: ["after", "against", "for", "versus"], answer: "against", explanation: "「〜に反対して」という意味の 'against' が適切です。" },
            { id: 'l10-t-15', lesson: 'l10-target', text: "The local basketball team lost a game at home for the first time ___ more than ten years.", options: ["at", "during", "in", "over"], answer: "in", explanation: "期間を表す前置詞 'in' が適切です。" },
            { id: 'l10-t-16', lesson: 'l10-target', text: "Kelly looked for somewhere to have a meal, but nowhere ___ a small cafe seemed to be open.", options: ["behind", "except", "neither", "without"], answer: "except", explanation: "「〜を除いて」という意味の 'except' が適切です。" },

            // Lesson 10: Review Quiz
            { id: 'l10-r-1', lesson: 'l10-review', text: "Our shop is currently ___ construction and we apologize for any inconvenience.", options: ["among", "during", "under", "with"], answer: "under", explanation: "「〜の建設中である」という意味の 'under construction' が適切です。" },
            { id: 'l10-r-2', lesson: 'l10-review', text: "Brian felt so nervous ___ the job interview that he was unable to answer all of the interviewer's questions.", options: ["among", "during", "when", "while"], answer: "during", explanation: "特定の期間中に」という意味の 'during' が適切です。" },
            { id: 'l10-r-3', lesson: 'l10-review', text: "Amy's dog slipped off its leash and ran halfway ___ the road before she could catch it again.", options: ["down", "since", "through", "until"], answer: "down", explanation: "「〜の途中で」という意味の 'down' が適切です。" },
            { id: 'l10-r-4', lesson: 'l10-review', text: "Dan Richardson repainted his room as the original color was not ___ his liking.", options: ["along", "by", "than", "to"], answer: "to", explanation: "「〜の好みに合わない」という意味の 'to one's liking' が適切です。" },
            { id: 'l10-r-5', lesson: 'l10-review', text: "Mr. Mason hoped he would be transferred to the Paris office ___ he had enjoyed his time there as a university student.", options: ["during", "for", "since", "whereas"], answer: "since", explanation: "「〜なので」という理由を表す接続詞 'since' が適切です。" },
            { id: 'l10-r-6', lesson: 'l10-review', text: "Passengers that need special assistance must check in at least 60 minutes ___ the departure of their flight.", options: ["after", "before", "by", "until"], answer: "before", explanation: "「〜の前に」という意味の 'before' が適切です。" },
            { id: 'l10-r-7', lesson: 'l10-review', text: "The employees in the IT department are all experienced and knowledgeable, ___ Charlotte Cooper.", options: ["against", "despite", "except", "over"], answer: "except", explanation: "「〜を除いて」という意味の 'except' が適切です。" },
            { id: 'l10-r-8', lesson: 'l10-review', text: "In a global ranking of meat consumption ___ person, Hong Kong is at the top and the United States of America is second.", options: ["as", "for", "per", "with"], answer: "per", explanation: "「〜につき」という意味の 'per' が適切です。" },

            // Lesson 11: TODAY's TARGET TEST
            { id: 'l11-t-1', lesson: 'l11-target', longText: "I recently placed an order ___ 10 liters of your Pollock Crown Range Matte Paint in color #407, Gray Wind.", text: "1. I recently placed an order ___ 10 liters of your Pollock Crown Range Matte Paint...", highlightText: "order ___ 10 liters", options: ["as", "by", "for", "to"], answer: "for", explanation: "「〜を注文する」という意味の 'order for' が適切です。" },
            { id: 'l11-t-2', lesson: 'l11-target', longText: "This order was delivered promptly, and I was excited to start painting my living room today. However, ___ opening the package, I discovered that what had been sent to me was actually 5 liters of color #309, Duck Egg.", text: "2. However, ___ opening the package, I discovered...", highlightText: "___ opening the package", options: ["at", "in", "until", "upon"], answer: "upon", explanation: "「〜するとすぐに」という意味の 'upon' が適切です。" },
            { id: 'l11-t-3', lesson: 'l11-target', longText: "This is not the usual excellent service I am used to receiving ___ your company. I hope that you will be able to supply me with the correct product as soon as possible as this will delay my home renovations.", text: "3. ...service I am used to receiving ___ your company.", highlightText: "receiving ___ your company", options: ["from", "of", "on", "into"], answer: "from", explanation: "「〜から受け取る」という意味の 'receive from' が適切です。" },
            { id: 'l11-t-4', lesson: 'l11-target', longText: "Hi Sofia,\n\nI hope you had a nice weekend! I hope you're not too tired after your race yesterday. I am mailing about our meeting with Mr. Behr ___ 11:00 tomorrow morning.", text: "4. ...our meeting with Mr. Behr ___ 11:00 tomorrow morning.", highlightText: "Mr. Behr ___ 11:00", options: ["at", "around", "to", "until"], answer: "at", explanation: "特定の時間を表す前置詞 'at' が適切です。" },
            { id: 'l11-t-5', lesson: 'l11-target', longText: "I have to go out after lunch, so if you have time, could you please set up the meeting room this afternoon? We need to put the projector on the table ___ the back wall of the room.", text: "5. We need to put the projector on the table ___ the back wall of the room.", highlightText: "table ___ the back wall", options: ["above", "against", "between", "within"], answer: "against", explanation: "「〜に立てかける」という意味の 'against' が適切です。" },
            { id: 'l11-t-6', lesson: 'l11-target', longText: "Let's meet ___ 10:00 a.m. at the latest to run through the presentation.", text: "6. Let's meet ___ 10:00 a.m. at the latest...", highlightText: "meet ___ 10:00 a.m.", options: ["along", "before", "by", "toward"], answer: "by", explanation: "「〜までに」という意味の 'by' が適切です。" },
            { id: 'l11-t-7', lesson: 'l11-target', longText: "Thank you for purchasing the Lamington L500 Handheld Vacuum Cleaner. Before using your product, please refer to the information ___ this card.", text: "7. ...please refer to the information ___ this card.", highlightText: "information ___ this card", options: ["across", "on", "of", "with"], answer: "on", explanation: "「〜に記載されている情報」という意味の 'information on' が適切です。" },
            { id: 'l11-t-8', lesson: 'l11-target', longText: "The battery in this vacuum cleaner has not been fully charged. After you have confirmed that the product is operational by briefly switching it on, please remove the battery and place it ___ the charger.", text: "8. ...place it ___ the charger.", highlightText: "place it ___ the charger", options: ["into", "off", "over", "toward"], answer: "into", explanation: "「〜の中に入れる」という意味の 'into' が適切です。" },
            { id: 'l11-t-9', lesson: 'l11-target', longText: "When charging the battery, please ensure that the charger is not placed ___ any walls or furniture as this may lead to the charger overheating.", text: "9. ...the charger is not placed ___ any walls or furniture...", highlightText: "placed ___ any walls", options: ["among", "at", "behind", "beside"], answer: "beside", explanation: "「〜のそばに」という意味の 'beside' が適切です。" },

            // Lesson 11: Review Quiz
            { id: 'l11-r-1', lesson: 'l11-review', longText: "This will take place ___ our store on Bank Street, where you will be working if your application is successful.", text: "1. This will take place ___ our store on Bank Street...", highlightText: "take place ___ our store", options: ["by", "in", "near", "on"], answer: "in", explanation: "場所を表す前置詞 'in' が適切です。" },
            { id: 'l11-r-2', lesson: 'l11-review', longText: "Are you free next Wednesday ___ 10:00 am and 12:00 p.m.? We will hold an information session and informal interview for candidates.", text: "2. Are you free next Wednesday ___ 10:00 am and 12:00 p.m.?", highlightText: "Wednesday ___ 10:00 am and 12:00 p.m.", options: ["around", "among", "between", "within"], answer: "between", explanation: "2つの時間の間を表す 'between' が適切です。" },
            { id: 'l11-r-3', lesson: 'l11-review', longText: "I will be out of the office ___ Friday to Tuesday...", highlightText: "office ___ Friday to Tuesday", options: ["for", "from", "until", "through"], answer: "from", explanation: "「〜から〜まで」という意味の 'from...to' が適切です。" },
            { id: 'l11-r-4', lesson: 'l11-review', longText: "VOLUNTEERS NEEDED\n\nDo you have some spare time during the week? Then why not help out ___ the Blackton Community Garden!", text: "4. ...why not help out ___ the Blackton Community Garden!", highlightText: "help out ___ the Blackton", options: ["about", "at", "on", "within"], answer: "at", explanation: "特定の場所での活動を表す前置詞 'at' が適切です。" },
            { id: 'l11-r-5', lesson: 'l11-review', longText: "We are in need of volunteers who can come on weekday mornings to help tend the gardens, harvest produce, and run workshops ___ local children.", text: "5. ...run workshops ___ local children.", highlightText: "workshops ___ local children", options: ["by", "for", "of", "to"], answer: "for", explanation: "「〜のために」という意味の 'for' が適切です。" },
            { id: 'l11-r-6', lesson: 'l11-review', longText: "If you can commit to at least one day ___ week, please give us a call at 555-0131 or send an e-mail to volunteer@blacktoncommunity.com for more information.", text: "6. If you can commit to at least one day ___ week...", highlightText: "one day ___ week", options: ["at", "in", "per", "with"], answer: "per", explanation: "「〜につき」という意味の 'per' が適切です。" },

            // Lesson 12: TODAY's TARGET TEST
            { id: 'l12-t-1', lesson: 'l12-target', longText: "International Airways, one of the largest carriers in the country, announce a new partnership with King Rental Cars this week. Under the new agreement, business class tickets will include car rental fees for up to three days in over 75 cities around the globe. Members of International's Business Fliers Club will be able to register for a rental car at their destination when purchasing tickets through the airlines' website.", text: "1. Who is eligible for participation in the new program?", highlightText: "Members of International's Business Fliers Club will be able to register", options: ["Business Fliers Club members", "Extended-stay travelers", "Frequent fliers on International Airways", "International Airways employees"], answer: "Business Fliers Club members", explanation: "ハイライト部分に「Internationalのビジネスフライヤーズクラブのメンバーが登録できる」と記載されています。" },
            { id: 'l12-t-2', lesson: 'l12-target', longText: "International and King Rental Cars tried this program out in ten cities over the past year, and the response from business travelers was overwhelmingly positive.", text: "2. What did the two companies do before they made a final decision?", highlightText: "tried this program out in ten cities over the past year", options: ["They did a small-scale trial of the idea.", "They requested opinions from holiday travelers.", "They researched the market for new trends.", "They used information about public transportation in many cities."], answer: "They did a small-scale trial of the idea.", explanation: "ハイライト部分に「過去1年間で10都市でこのプログラムを試した」と記載されており、これは小規模な試行を意味します。" },
            { id: 'l12-t-3', lesson: 'l12-target', longText: "This promises to streamline the process for car rental, saving time and money for both travelers and the two companies. Business travelers will be able to go directly from baggage claim to a rental car lot without having to register at the airport rental car office.", text: "3. How does the new program improve efficiency for targeted customers?", highlightText: "go directly from baggage claim to a rental car lot without having to register at the airport rental car office", options: ["It chooses the right type of vehicle for each business.", "It eliminates the need for reservations.", "It is aimed at certain businesspeople who travel a lot.", "It makes the rental process quicker and easier."], answer: "It makes the rental process quicker and easier.", explanation: "ハイライト部分に「空港のレンタカーオフィスで登録する必要なく、手荷物受取所から直接レンタカーの駐車場へ行ける」と記載されており、これはプロセスを迅速かつ容易にすることを意味します。" },
            { id: 'l12-t-4', lesson: 'l12-target', longText: "This year's theme is 'The Future of Newburg.' Essays must be no more than 1,500 words and should examine some aspect of the future of our community. You can write on any aspect of how Newburg will face the coming decades.", text: "4. Which topic is suitable to this year's contest?", highlightText: "This year's theme is 'The Future of Newburg.'", options: ["The current industry in Newburg", "The upcoming prospects of Newburg", "The landmarks in Newburg", "The traditions of Newburg"], answer: "The upcoming prospects of Newburg", explanation: "今年のテーマは「ニューバーグの未来」であり、これは今後の見通しについて書くことを意味します。" },
            { id: 'l12-t-5', lesson: 'l12-target', longText: "Employees of the Newburg Times are not allowed to submit essays. All others are encouraged to participate.", text: "5. Who can NOT participate in the contest?", highlightText: "Employees of the Newburg Times are not allowed to submit essays.", options: ["Anyone under 18 years of age", "City officials", "People who work for the newspaper", "Previous winners"], answer: "People who work for the newspaper", explanation: "ハイライト部分に「ニューバーグタイムズの従業員はエッセイを提出することを許可されていない」と記載されています。" },

            // Lesson 12: Review Quiz
            { id: 'l12-r-1', lesson: 'l12-review', longText: "Regent started in the semiconductor industry but has moved into computer processor manufacturing in the past decade. That now accounts for more than 50 percent of the company's revenue.", text: "1. What makes up most of Regent's business?", highlightText: "moved into computer processor manufacturing... now accounts for more than 50 percent of the company's revenue.", options: ["Constructing computer servers", "Fabricating computer processors", "Making large data storage devices", "Producing semiconductors"], answer: "Fabricating computer processors", explanation: "ハイライト部分に「コンピュータプロセッサ製造に移行し、現在では会社の収益の50％以上を占めている」と記載されています。" },
            { id: 'l12-r-2', lesson: 'l12-review', longText: "Manufacturing the processors in the US has become too expensive for Regent to stay competitive within the industry, so they have built a new plant in Cortez, Mexico. A spokesman for the company said that it was the best option available to them. It is possible to manufacture the processors even more cheaply overseas, but Mexico is still cheaper than the US, and is not as far from Arizona.", text: "2. What is an advantage of the plant's new location?", highlightText: "Mexico is still cheaper than the US, and is not as far from Arizona.", options: ["It is close to the company headquarters.", "It is far from the company's competitors.", "It is larger than other potential locations.", "It will cut shipping costs."], answer: "It is close to the company headquarters.", explanation: "ハイライト部分に「メキシコは米国よりも安く、アリゾナからもそれほど遠くない」と記載されており、これは本社に近いことを意味します。" },
            { id: 'l12-r-3', lesson: 'l12-review', longText: "They will retain many employees from their current Arizona plant, but they will be moved to the Mexico plant to serve as supervisors in the new facility. The Arizona plant is expected to shut down in 2018.", text: "3. What are many employees at the old plant expected to do in 2017?", highlightText: "they will be moved to the Mexico plant to serve as supervisors", options: ["Manufacture new products", "Take an early retirement", "Train for different jobs within the company", "Transfer to the new plant"], answer: "Transfer to the new plant", explanation: "ハイライト部分に「メキシコの工場に異動して監督者として勤務する」と記載されています。" },

            // Lesson 13: TODAY's TARGET TEST
            { id: 'l13-t-1', lesson: 'l13-target', text: "The team leader has to ___ how many hours will be required for the project by next Monday.", options: ["align", "delete", "estimate", "increase"], answer: "estimate", explanation: "「〜を見積もる」という意味の動詞 'estimate' が適切です。" },
            { id: 'l13-t-2', lesson: 'l13-target', text: "Although Bill Norton had ___ met the woman who spoke to him at the party, he could not remember her name.", options: ["early", "hardly", "gradually", "previously"], answer: "previously", explanation: "「以前に」という意味の副詞 'previously' が適切です。" },
            { id: 'l13-t-3', lesson: 'l13-target', text: "As part of its office remodeling, the company ___ all the old computers with the latest laptops.", options: ["recovered", "reorganized", "replaced", "required"], answer: "replaced", explanation: "「〜を交換する」という意味の動詞 'replaced' が適切です。" },
            { id: 'l13-t-4', lesson: 'l13-target', text: "Due to an urgent appointment requested by his client, the sales manager had to cancel the ___ scheduled staff meeting.", options: ["highly", "preferably", "regularly", "shortly"], answer: "regularly", explanation: "「定期的に」という意味の副詞 'regularly' が適切です。" },
            { id: 'l13-t-5', lesson: 'l13-target', text: "Please give us your ___ on our products and service, and we will send you a coupon to use for your next purchase.", options: ["comeback", "cutback", "feedback", "setback"], answer: "feedback", explanation: "「意見、感想」という意味の 'feedback' が適切です。" },
            { id: 'l13-t-6', lesson: 'l13-target', text: "In order to obtain Japanese citizenship, it is ___ to have lived in Japan for more than five years.", options: ["available", "convenient", "necessary", "possible"], answer: "necessary", explanation: "「〜することが必要である」という意味の 'necessary' が適切です。" },
            { id: 'l13-t-7', lesson: 'l13-target', text: "The Ocean Kitchen is the first restaurant in Everton City that ___ Mediterranean food.", options: ["attracts", "brings", "presents", "serves"], answer: "serves", explanation: "「（料理を）出す、提供する」という意味の動詞 'serves' が適切です。" },
            { id: 'l13-t-8', lesson: 'l13-target', text: "Four casters with stoppers are attached to the base of the cabinet so that it can be moved ___.", options: ["barely", "easily", "newly", "shortly"], answer: "easily", explanation: "「簡単に」という意味の副詞 'easily' が適切です。" },
            { id: 'l13-t-9', lesson: 'l13-target', text: "This seminar will ___ on how media organizations are creating and adapting to new business models.", options: ["appear", "count", "focus", "insist"], answer: "focus", explanation: "「〜に焦点を当てる」という意味の 'focus on' が適切です。" },
            { id: 'l13-t-10', lesson: 'l13-target', text: "In order to fix the problem concerning the intranet, the technician had to stay ___ at the company.", options: ["overboard", "overhead", "overnight", "overseas"], answer: "overnight", explanation: "「一晩中」という意味の 'overnight' が適切です。" },
            { id: 'l13-t-11', lesson: 'l13-target', text: "If you are looking for a job in the financial ___, ProRecruiters can help you find the perfect position.", options: ["field", "place", "region", "territory"], answer: "field", explanation: "「分野」という意味の 'field' が適切です。" },
            { id: 'l13-t-12', lesson: 'l13-target', text: "A schedule of ___ meetings will be sent to employees by e-mail by the end of the day.", options: ["all", "each", "every", "no"], answer: "all", explanation: "「すべての会議の」という意味の 'all' が適切です。" },
            { id: 'l13-t-13', lesson: 'l13-target', text: "With this new smartphone application, drivers can choose a better route to ___ traffic jam.", options: ["avoid", "break", "escape", "lose"], answer: "avoid", explanation: "「〜を避ける」という意味の動詞 'avoid' が適切です。" },
            { id: 'l13-t-14', lesson: 'l13-target', text: "The biotech firm had to give up on their research project because of the ___ high cost of scientific equipment.", options: ["exactly", "extensively", "externally", "extremely"], answer: "extremely", explanation: "「極めて、非常に」という意味の副詞 'extremely' が適切です。" },
            { id: 'l13-t-15', lesson: 'l13-target', text: "Recent study shows that people ___ to tell the truth more often in text messages than in face-to-face interactions.", options: ["bend", "lend", "mend", "tend"], answer: "tend", explanation: "「〜する傾向がある」という意味の 'tend to' が適切です。" },
            { id: 'l13-t-16', lesson: 'l13-target', text: "When a college staff member recognized suspicious activity by hackers, the school ___ shut down its website.", options: ["commonly", "delightfully", "immediately", "respectfully"], answer: "immediately", explanation: "「すぐに」という意味の副詞 'immediately' が適切です。" },

            // Lesson 13: Review Quiz
            { id: 'l13-r-1', lesson: 'l13-review', text: "Please ___ this questionnaire and send it to the admissions office together with other application documents.", options: ["complete", "describe", "participate", "write"], answer: "complete", explanation: "「〜を完成させる」という意味の動詞 'complete' が適切です。" },
            { id: 'l13-r-2', lesson: 'l13-review', text: "It was not easy for the 40-year-old man to decide to leave the company and study ___.", options: ["abroad", "ahead", "alike", "aloud"], answer: "abroad", explanation: "「海外で」という意味の副詞 'abroad' が適切です。" },
            { id: 'l13-r-3', lesson: 'l13-review', text: "The factory manager told section leaders to make sure that ___ worker knows how to properly and safely operate machinery.", options: ["all", "each", "few", "some"], answer: "each", explanation: "「それぞれの」という意味の 'each' が適切です。" },
            { id: 'l13-r-4', lesson: 'l13-review', text: "As she set a new record at the national swimming championships, May Craig was ___ for the Olympic team.", options: ["decided", "determined", "played", "selected"], answer: "selected", explanation: "「〜に選ばれる」という意味の 'selected for' が適切です。" },
            { id: 'l13-r-5', lesson: 'l13-review', text: "When you're tired, it's ___ more difficult to concentrate, manage stress and stay productive.", options: ["almost", "even", "only", "very"], answer: "even", explanation: "比較級を強調する 'even' が適切です。" },
            { id: 'l13-r-6', lesson: 'l13-review', text: "Many actors gathered to attend the famous director's birthday ___ held at the rooftop garden of the Raft Hotel.", options: ["celebration", "communication", "fabrication", "invitation"], answer: "celebration", explanation: "「祝賀会」という意味の 'celebration' が適切です。" },
            { id: 'l13-r-7', lesson: 'l13-review', text: "Henry Gibbs started his business ___ in scrapping old cars in Lake City more than 30 years ago.", options: ["computerizing", "downsizing", "emphasizing", "specializing"], answer: "specializing", explanation: "「〜を専門とする」という意味の 'specializing in' が適切です。" },
            { id: 'l13-r-8', lesson: 'l13-review', text: "Through the website, the young girl learned about a lot of new bands that she didn't know about ___.", options: ["again", "ago", "before", "ever"], answer: "before", explanation: "「以前に」という意味の 'before' が適切です。" },

            // Lesson 14: Final Review Test Part 5
            { id: 'l14-r-p5-1', lesson: 'l14-review-part5', text: "Because his report was due today, Chad Anderson had his colleague ___ him with it.", options: ["help", "helped", "helping", "to help"], answer: "help", explanation: "使役動詞 'had' の後に動詞の原形 'help' が適切です。" },
            { id: 'l14-r-p5-2', lesson: 'l14-review-part5', text: "Despite widespread media speculation, both companies have ___ to make an official announcement on the merger.", options: ["already", "even", "just", "yet"], answer: "yet", explanation: "否定文で「まだ〜していない」という意味の 'yet' が適切です。" },
            { id: 'l14-r-p5-3', lesson: 'l14-review-part5', text: "The retirement dinner for Joanna Kearns will be Friday evening and all guests are expected to wear formal ___.", options: ["attire", "base", "gear", "outfit"], answer: "attire", explanation: "「服装」という意味の 'attire' が適切です。" },
            { id: 'l14-r-p5-4', lesson: 'l14-review-part5', text: "The grocery store is known for selling only vegetables and fruits that are grown or produced ___.", options: ["local", "localization", "localize", "locally"], answer: "locally", explanation: "動詞 'grown or produced' を修飾する副詞 'locally' が適切です。" },
            { id: 'l14-r-p5-5', lesson: 'l14-review-part5', text: "Although both buses 47A and 298 go to Sanford Park, 298 will get there ___ because it doesn't stop as often.", options: ["fast", "faster", "fastest", "fasten"], answer: "faster", explanation: "比較を表す形容詞の比較級 'faster' が適切です。" },
            { id: 'l14-r-p5-6', lesson: 'l14-review-part5', text: "Much to his surprise, Jim Harris realized that by the end of this year, he ___ in Tokyo for ten years.", options: ["has lived", "lives", "will have lived", "will live"], answer: "will have lived", explanation: "今年の終わりまでに完了する行動を表すため、未来完了形 'will have lived' が適切です。" },
            { id: 'l14-r-p5-7', lesson: 'l14-review-part5', text: "Recent study shows that people ___ to tell the truth more often in text messages than in face-to-face interactions.", options: ["bend", "lend", "mend", "tend"], answer: "tend", explanation: "「〜する傾向がある」という意味の 'tend to' が適切です。" },
            { id: 'l14-r-p5-8', lesson: 'l14-review-part5', text: "There is no cancellation fee, ___ that it is requested more than 60 days before the departure of the tour.", options: ["provide", "provided", "provides", "to provide"], answer: "provided", explanation: "「〜という条件で」という意味の接続詞 'provided that' が適切です。" },
            { id: 'l14-r-p5-9', lesson: 'l14-review-part5', text: "It would be greatly ___ if you could send me the latest catalogue of your products.", options: ["appreciate", "appreciated", "appreciation", "appreciatively"], answer: "appreciated", explanation: "「〜ならば感謝されるでしょう」という受動態の 'be appreciated' が適切です。" },
            { id: 'l14-r-p5-10', lesson: 'l14-review-part5', text: "As part of its office remodeling, the company ___ all the old computers with the latest laptops.", options: ["recovered", "reorganized", "replaced", "required"], answer: "replaced", explanation: "「〜を交換する」という意味の動詞 'replaced' が適切です。" },
            { id: 'l14-r-p5-11', lesson: 'l14-review-part5', text: "In his long career at Schular Motors, Jim ___ extraordinary management skills as well as an in-depth understanding of the automotive industry.", options: ["has demonstrated", "to demonstrate", "demonstrating", "was demonstrated"], answer: "has demonstrated", explanation: "長年のキャリアを通じて現在まで「実証してきた」という意味の現在完了形 'has demonstrated' が適切です。" },
            { id: 'l14-r-p5-12', lesson: 'l14-review-part5', text: "This e-mail is to inform you that the new payroll system ___ into effect on April 1st.", options: ["come", "had come", "will come", "would have come"], answer: "will come", explanation: "「4月1日に発効する」という未来の出来事を表すため、未来形 'will come' が適切です。" },
            { id: 'l14-r-p5-13', lesson: 'l14-review-part5', text: "We have not gotten a reply from three of the board members yet, as ___ as I know.", options: ["far", "long", "soon", "well"], answer: "far", explanation: "「私の知る限りでは」という意味の 'as far as I know' が適切です。" },
            { id: 'l14-r-p5-14', lesson: 'l14-review-part5', text: "Miyuki Tyson ___ as a criminal lawyer specializing in youth crimes in Las Vegas since the mid-1980s.", options: ["works", "worked", "will work", "has been working"], answer: "has been working", explanation: "1980年代半ばから現在まで続いている行動を表すため、現在完了進行形 'has been working' が適切です。" },
            { id: 'l14-r-p5-15', lesson: 'l14-review-part5', text: "Liam Woods is well known as a social ___, best-selling author and radio talk-show host.", options: ["active", "actively", "activity", "activist"], answer: "activist", explanation: "「社会活動家」という意味で人を示す名詞 'activist' が適切です。" },
            { id: 'l14-r-p5-16', lesson: 'l14-review-part5', text: "The sales manager was so busy with work ___ he did not have time to read the pile of reports on his desk.", options: ["that", "this", "it", "what"], answer: "that", explanation: "「とても〜なので…」という意味の 'so...that' 構文が適切です。" },

            // Lesson 14: Final Review Test Part 6 & 7
            { id: 'l14-r-p67-1', lesson: 'l14-review-part67', longText: "To: Pierre Gerard <pgerard@WonderDesign.com>\nDate/Time: July 18/15:46:21\nSubject: Your Presentation\n\nDear Mr. Gerard,\n\nI would like to remind you of your presentation here next Tuesday, July 23, in which you will explain your proposed design for the new city hall. The presentation ___ at 1:30.", text: "17. The presentation ___ at 1:30.", highlightText: "The presentation ___ at 1:30.", options: ["start", "was started", "will start", "started"], answer: "will start", explanation: "「次の火曜日」という未来の時間を表すため、未来形 'will start' が適切です。" },
            { id: 'l14-r-p67-2', lesson: 'l14-review-part67', longText: "To ensure that you have enough time to set up the projector and do any last-minute preparations, please arrive at least 15 minutes in advance. When you come through the main entrance, tell the receptionist, Donna Green, that you are here to see me in the city planning division. She will ___ guide you to the office.", text: "18. She will ___ guide you to the office.", highlightText: "She will ___ guide you to the office.", options: ["then", "also", "always", "plus"], answer: "then", explanation: "「それから、その後」という意味の副詞 'then' が適切です。" },
            { id: 'l14-r-p67-3', lesson: 'l14-review-part67', longText: "As I mentioned earlier, six members of city council, ___ Deputy Mayor Joe Cartwright will also attend the presentation. Therefore, please prepare at least seven copies of any handouts to distribute.", text: "19. As I mentioned earlier, six members of city council, ___ Deputy Mayor Joe Cartwright will also attend the presentation.", highlightText: "six members of city council, ___ Deputy Mayor Joe Cartwright", options: ["with regard to", "in compliance with", "in addition to", "for the sake of"], answer: "in addition to", explanation: "「〜に加えて」という意味のフレーズ 'in addition to' が適切です。" },
            { id: 'l14-r-p67-4', lesson: 'l14-review-part67', longText: "SAFETY RECALL\nCRAMER BOY'S HOODED FLEECE\nStyle No. 41204106\n\nCramer Clothing, in cooperation with the Consumer Product Safety Agency, is ___ recalling a boy's hooded long sleeve fleece jacket.", text: "20. Cramer Clothing... is ___ recalling a boy's hooded long sleeve fleece jacket.", highlightText: "is ___ recalling a boy's hooded long sleeve fleece jacket", options: ["voluntary", "voluntarily", "volunteer", "volunteering"], answer: "voluntarily", explanation: "動詞 'recalling' を修飾する副詞 'voluntarily' が適切です。" },
            { id: 'l14-r-p67-5', lesson: 'l14-review-part67', longText: "This hooded long sleeve fleece jacket has a neck drawstring that could become tied too ___ for children to undo. In a small number of cases, the string posed a risk to wearers.", text: "21. ...tied too ___ for children to undo.", highlightText: "tied too ___ for children to undo.", options: ["tighter", "tighten", "tightly", "tightness"], answer: "tightly", explanation: "動詞 'tied' を修飾する副詞 'tightly' が適切です。" },
            { id: 'l14-r-p67-6', lesson: 'l14-review-part67', longText: "Parents can ___ the safety risk by cutting and removing the neck drawstring. Customers may also return this outerwear to the store...", text: "22. Parents can ___ the safety risk by cutting and removing the neck drawstring.", highlightText: "Parents can ___ the safety risk by cutting", options: ["eliminate", "elimination", "eliminator", "eliminatory"], answer: "eliminate", explanation: "助動詞 'can' の後に動詞の原形 'eliminate' が必要です。" },
            { id: 'l14-r-p67-7', lesson: 'l14-review-part67', longText: "A fantastic event: The Transportation Expo\n\nThe Transportation Expo takes visitors on a tour of the past and present of transport... The Metropolitan History Association is one of the event's sponsors as ___ as an exhibitor.", text: "23. ...sponsors as ___ as an exhibitor.", highlightText: "sponsors as ___ as an exhibitor", options: ["many", "much", "soon", "well"], answer: "well", explanation: "「〜と同様に」という意味のフレーズ 'as well as' が適切です。" },
            { id: 'l14-r-p67-8', lesson: 'l14-review-part67', longText: "There is ___ much to see and do at the Expo to write it all here, but I have to mention the MHA exhibit. This amazing interactive trip through the history of public transportation has equal appeal to kids and kids at heart.", text: "24. There is ___ much to see and do at the Expo to write it all here...", highlightText: "There is ___ much to see and do", options: ["enough", "such", "too", "way"], answer: "too", explanation: "「〜すぎて…できない」という意味の 'too...to' 構文が適切です。" },
            { id: 'l14-r-p67-9', lesson: 'l14-review-part67', longText: "The Expo's hours are 10:00 a.m. to 6:00 p.m. daily, ___ for Mondays. Tickets are available at the door.", text: "25. The Expo's hours are 10:00 a.m. to 6:00 p.m. daily, ___ for Mondays.", highlightText: "daily, ___ for Mondays.", options: ["according", "except", "only", "whereas"], answer: "except", explanation: "「〜を除いて」という意味の 'except for' が適切です。" },
            { id: 'l14-r-p67-10', lesson: 'l14-review-part67', longText: "Architectural Tour of Mills Valley\nDays: Tuesdays and Thursdays at 1:00\nPrice: $25.00 adults, $15.00 senior citizens\nStart Location: Mills Valley Courthouse\nFinish Location: Mills Valley Public Library\nTime: Approximately 4 hours\nThis half-day walking tour...", text: "26. When are participants scheduled to leave the public library?", highlightText: "Start Location: Mills Valley Courthouse\nFinish Location: Mills Valley Public Library\nTime: Approximately 4 hours", options: ["At 1:00 p.m.", "At 2:00 p.m.", "At 4:00 p.m.", "At 5:00 p.m."], answer: "At 5:00 p.m.", explanation: "ツアー開始が午後1時で、所要時間が約4時間なので、午後5時に図書館を出発することになります。" },
            { id: 'l14-r-p67-11', lesson: 'l14-review-part67', longText: "This half-day walking tour of Mills Valley's architectural landmarks gives you a chance to see some of the area's most famous buildings up close... All of these buildings were built during the 1920s and 1930s and convey the styles of famous architects of the era such as Eichler and Wexler. It should be fun and educational for architecture buffs and anyone who likes to see unique landmarks.", text: "27. What is the focus of the tour?", highlightText: "walking tour of Mills Valley's architectural landmarks", options: ["Mills Valley buildings old and new", "Public buildings in the area", "The history of Mills Valley", "Unique architecture in the area"], answer: "Unique architecture in the area", explanation: "ツアーは「ミルズバレーの建築的ランドマーク」に焦点を当てています。" },
            { id: 'l14-r-p67-12', lesson: 'l14-review-part67', longText: "Market Watch announces new editor-in-chief\nMarket Watch, a leading financial weekly, has announced a new editor-in-chief. Jan Spellman will replace George Rogers at the beginning of the year. Mr. Rogers headed the magazine for the past decade... Under his leadership, Market Watch was one of the first magazines to go entirely online... he pioneered digital subscriptions and managed to keep advertising revenue at high levels... He wrote many important articles about the real-estate collapse and won several awards, including Journalist of the Year.", text: "28. What is NOT one of Mr. Rogers' accomplishments?", highlightText: "Under his leadership, Market Watch was one of the first magazines to go entirely online... he pioneered digital subscriptions and managed to keep advertising revenue at high levels... won several awards, including Journalist of the Year.", options: ["Keeping advertising money flowing", "Leading the way in online publishing", "Serving on the board of a finance firm", "Winning journalist's awards"], answer: "Serving on the board of a finance firm", explanation: "記事には、広告収入維持、オンライン出版の先駆者、ジャーナリスト賞受賞が記載されていますが、金融会社の役員を務めたことは言及されていません。" },
            { id: 'l14-r-p67-13', lesson: 'l14-review-part67', longText: "Mr. Rogers won't be in the magazine business anymore, but he plans to write a book about digital media. Jan Spellman comes to Market Watch from The Financial Republic, an economic newspaper that is very widely circulated in Europe.", text: "29. Why is Mr. Rogers leaving Market Watch?", highlightText: "Mr. Rogers won't be in the magazine business anymore, but he plans to write a book about digital media.", options: ["He has been hired by The Financial Republic.", "He is going to pursue other interests.", "He was asked to take an early retirement.", "The magazine is floundering."], answer: "He is going to pursue other interests.", explanation: "ハイライト部分に「彼はもう雑誌業界にはいないが、デジタルメディアに関する本を書く予定だ」と記載されており、これは他の関心事を追求することを意味します。" },
            { id: 'l14-r-p67-14', lesson: 'l14-review-part67', longText: "Jan Spellman comes to Market Watch from The Financial Republic, an economic newspaper that is very widely circulated in Europe. She leaves the Republic after a five-year stint as the international banking reporter. She is known for her insight into political and financial issues and keen news reporting. She will maintain a reporting position in addition to her duties as editor-in-chief.", text: "30. Which topic will the new editor-in-chief most likely write about?", highlightText: "She leaves the Republic after a five-year stint as the international banking reporter.", options: ["Digital publishing", "Financial matters abroad", "Online marketing", "Real estate"], answer: "Financial matters abroad", explanation: "彼女は「国際銀行記者」としての5年間の勤務を経ており、海外の金融問題について書く可能性が高いです。" }
        ];

        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectQuestionIds = [];
        let correctlyAnsweredByLesson = {};
        let consecutiveCorrectCounts = {};
        let sessionIncorrectQuestionIds = [];
        let answeredQuestions = new Set();
        let currentMode = 'random';
        let questionCount = 10;
        let showProgress = true;
        let enableSound = true;
        let masteryMode = false;
        let confettiAnimationId;

        // --- Sound Effect Setup ---
        const sounds = {
            correct: new Tone.Synth({ volume: -12, oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
            incorrect: new Tone.FMSynth({ volume: -8, harmonicity: 1.5, modulationIndex: 10, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.1 } }).toDestination(),
            click: new Tone.Synth({ volume: -15, oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.01, release: 0.1 } }).toDestination(),
            fanfare: new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination(),
        };

        function playSound(type) {
            if (!enableSound || Tone.context.state !== 'running') return;
            const now = Tone.now();
            try {
                switch (type) {
                    case 'correct': sounds.correct.triggerAttackRelease("C5", "8n", now); break;
                    case 'incorrect': sounds.incorrect.triggerAttackRelease("A2", "8n", now); break;
                    case 'click': sounds.click.triggerAttackRelease("C6", "16n", now); break;
                    case 'fanfare':
                        const fanfareNotes = ["C5", "E5", "G5", "C6"];
                        fanfareNotes.forEach((note, i) => {
                            sounds.fanfare.triggerAttackRelease(note, "8n", now + i * 0.15);
                        });
                        break;
                }
            } catch (error) {
                console.error("Sound playback failed:", error);
            }
        }
        
        // --- DOM Elements ---
        const startScreen = document.getElementById('startScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultScreen = document.getElementById('resultScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const quizModeSelect = document.getElementById('quizModeSelect');
        const startButton = document.getElementById('startButton');
        const settingsButton = document.getElementById('settingsButton');
        const backToStartButton = document.getElementById('backToStartButton');
        const longTextArea = document.getElementById('longTextArea');
        const questionTextElement = document.getElementById('questionText');
        const optionsGridElement = document.getElementById('optionsGrid');
        const feedbackMessageElement = document.getElementById('feedbackMessage');
        const feedbackResultElement = document.getElementById('feedbackResult');
        const explanationContentElement = document.getElementById('explanationContent');
        const explanationTextElement = explanationContentElement.querySelector('.explanation-text');
        const toggleExplanationButton = document.getElementById('toggleExplanationButton');
        const nextButton = document.getElementById('nextButton');
        const interruptButton = document.getElementById('interruptButton');
        const progressBarContainer = document.querySelector('.progress-container');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const finalScore = document.getElementById('finalScore');
        const scoreComment = document.getElementById('scoreComment');
        const confettiContainer = document.getElementById('confettiContainer');
        const restartButton = document.getElementById('restartButton');
        const redoIncorrectButton = document.getElementById('redoIncorrectButton');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const themeColorCircles = document.querySelectorAll('.color-circle');
        const questionCountSelect = document.getElementById('questionCountSelect');
        const showProgressToggle = document.getElementById('showProgressToggle');
        const enableSoundToggle = document.getElementById('enableSoundToggle');
        const masteryModeToggle = document.getElementById('masteryModeToggle');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');

        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.add('show');
            modalConfirmButton.style.display = onConfirm ? 'inline-block' : 'none';
            modalCancelButton.textContent = onConfirm ? 'いいえ' : '閉じる';
            modalConfirmButton.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
            modalCancelButton.onclick = closeModal;
        }
        function closeModal() { modal.classList.remove('show'); }
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        const themes = {
            'default': { light: { '--nav-button-bg': '#0ea5e9', '--nav-button-hover-bg': '#0284c7', '--nav-button-shadow': 'rgba(14, 165, 233, 0.3)', '--progress-bar-bg': '#0ea5e9', '--bg-primary': 'var(--bg-primary-default)', '--themed-text-color': '#0c4a6e' } },
            'red': { light: { '--nav-button-bg': '#ef4444', '--nav-button-hover-bg': '#dc2626', '--nav-button-shadow': 'rgba(239, 68, 68, 0.3)', '--progress-bar-bg': '#ef4444', '--bg-primary': 'var(--bg-primary-red)', '--themed-text-color': '#991b1b' } },
            'green': { light: { '--nav-button-bg': '#10b981', '--nav-button-hover-bg': '#059669', '--nav-button-shadow': 'rgba(16, 185, 129, 0.3)', '--progress-bar-bg': '#10b981', '--bg-primary': 'var(--bg-primary-green)', '--themed-text-color': '#065f46' } },
            'indigo': { light: { '--nav-button-bg': '#6366f1', '--nav-button-hover-bg': '#4f46e5', '--nav-button-shadow': 'rgba(99, 102, 241, 0.3)', '--progress-bar-bg': '#6366f1', '--bg-primary': 'var(--bg-primary-indigo)', '--themed-text-color': '#4338ca' } }
        };
        
        const darkThemeOverrides = {
            'default': { '--bg-primary': 'var(--bg-primary-default)', '--themed-text-color': '#e0f2fe' },
            'red': { '--bg-primary': 'var(--bg-primary-red)', '--themed-text-color': '#fca5a5' },
            'green': { '--bg-primary': 'var(--bg-primary-green)', '--themed-text-color': '#a7f3d0' },
            'indigo': { '--bg-primary': 'var(--bg-primary-indigo)', '--themed-text-color': '#c7d2fe' }
        };

        function applyColors(themeName, isDark) {
            const root = document.documentElement;
            const defaultLightColors = { '--bg-secondary': '#ffffff', '--text-primary': '#1e293b', '--text-secondary': '#64748b', '--button-bg-default': '#f1f5f9', '--button-text-default': '#334155', '--button-border-default': '#cbd5e1', '--start-button-bg': '#10b981', '--start-button-hover-bg': '#059669', '--start-button-shadow': 'rgba(16, 185, 129, 0.3)', '--interrupt-button-bg': '#ef4444', '--interrupt-button-hover-bg': '#dc2626', '--interrupt-button-shadow': 'rgba(239, 68, 68, 0.3)', '--feedback-bg': '#f8fafc', '--feedback-border': '#e2e8f0', '--correct-feedback-text': '#15803d', '--correct-feedback-border': '#22c55e', '--incorrect-feedback-text': '#b91c1c', '--incorrect-feedback-border': '#ef4444', '--correct-option-bg': '#dcfce7', '--incorrect-option-bg': '#fee2e2', '--score-color': '#0c4a6e', '--score-comment-color': '#0369a1', '--settings-button-bg': '#6366f1', '--settings-button-hover-bg': '#4f46e5', '--settings-button-shadow': 'rgba(99, 102, 241, 0.3)' };
            const darkThemeColors = { '--bg-secondary': '#1e293b', '--text-primary': '#e2e8f0', '--text-secondary': '#94a3b8', '--button-bg-default': '#334155', '--button-text-default': '#e2e8f0', '--button-border-default': '#475569', '--nav-button-bg': '#38bdf8', '--nav-button-hover-bg': '#0ea5e9', '--nav-button-shadow': 'rgba(56, 189, 248, 0.3)', '--start-button-bg': '#2dd4bf', '--start-button-hover-bg': '#14b8a6', '--start-button-shadow': 'rgba(45, 212, 191, 0.3)', '--interrupt-button-bg': '#f87171', '--interrupt-button-hover-bg': '#ef4444', '--interrupt-button-shadow': 'rgba(248, 113, 113, 0.3)', '--progress-bar-bg': '#38bdf8', '--feedback-bg': '#334155', '--feedback-border': '#475569', '--correct-feedback-text': '#a7f3d0', '--correct-feedback-border': '#4ade80', '--incorrect-feedback-text': '#fecaca', '--incorrect-feedback-border': '#f87171', '--correct-option-bg': '#14532d', '--incorrect-option-bg': '#7f1d1d', '--score-color': '#e0f2fe', '--score-comment-color': '#7dd3fc', '--settings-button-bg': '#818cf8', '--settings-button-hover-bg': '#6366f1', '--settings-button-shadow': 'rgba(129, 140, 248, 0.3)' };
            
            if (isDark) {
                Object.entries(darkThemeColors).forEach(([prop, value]) => root.style.setProperty(prop, value));
                const themeOverrides = darkThemeOverrides[themeName] || darkThemeOverrides.default;
                Object.entries(themeOverrides).forEach(([prop, value]) => root.style.setProperty(prop, value));
            } else {
                Object.entries(defaultLightColors).forEach(([prop, value]) => root.style.setProperty(prop, value));
                const themeOverrides = themes[themeName]?.light || themes.default.light;
                Object.entries(themeOverrides).forEach(([prop, value]) => root.style.setProperty(prop, value));
            }
        }

        function setDarkMode(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem(APP_PREFIX + 'darkMode', isDark);
            applyColors(localStorage.getItem(APP_PREFIX + 'themeColor') || 'default', isDark);
        }

        function setThemeColor(themeName) {
            localStorage.setItem(APP_PREFIX + 'themeColor', themeName);
            applyColors(themeName, document.body.classList.contains('dark-mode'));
        }

        function switchScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenToShow.classList.add('active');
            window.scrollTo(0, 0);
        }

        async function prepareQuiz() {
            if (Tone.context.state !== 'running') await Tone.start();
            playSound('click');
            currentMode = quizModeSelect.value;
            localStorage.setItem(APP_PREFIX + 'lastSelectedMode', currentMode);
            questionCount = parseInt(questionCountSelect.value, 10);
            localStorage.setItem(APP_PREFIX + 'questionCount', questionCount);
            
            currentQuestions = [];
            answeredQuestions.clear();
            sessionIncorrectQuestionIds = [];
            score = 0;
            currentQuestionIndex = 0;

            let sourcePool = [];
            const isLessonMode = currentMode !== 'random' && currentMode !== 'incorrect';

            if (isLessonMode) {
                const allLessonQuestions = allQuestions.filter(q => q.lesson === currentMode);
                const correctlyAnsweredIds = correctlyAnsweredByLesson[currentMode] || [];
                
                if (allLessonQuestions.length > 0 && correctlyAnsweredIds.length >= allLessonQuestions.length) {
                        showModal('レッスン完了！', 'このレッスンの全問題をマスターしました！進捗をリセットして、もう一度挑戦しますか？', () => {
                            correctlyAnsweredByLesson[currentMode] = [];
                            localStorage.setItem(APP_PREFIX + 'correctlyAnsweredByLesson', JSON.stringify(correctlyAnsweredByLesson));
                            updateLessonDropdown();
                            // Directly restart the quiz for this lesson after reset
                            const lessonQuestions = allQuestions.filter(q => q.lesson === currentMode);
                            currentQuestions = lessonQuestions.slice(0, questionCount);
                            if(currentQuestions.length > 0) {
                                switchScreen(quizScreen);
                                loadQuestion();
                            }
                        });
                        return;
                }
                sourcePool = allLessonQuestions.filter(q => !correctlyAnsweredIds.includes(q.id));

            } else if (currentMode === 'incorrect') {
                sourcePool = allQuestions.filter(q => incorrectQuestionIds.includes(q.id));
                if (sourcePool.length === 0) {
                    showModal('苦手克服モード', '現在、間違えた問題がありません。よくできました！');
                    return;
                }
            } else { // random mode
                sourcePool = allQuestions;
            }

            // Lessons with long text passages that should not be shuffled
            const noShuffleLessons = [
                'l2-target', 'l2-review', 'l3-target', 'l3-review', 'l5-target', 'l5-review',
                'l6-target', 'l6-review', 'l8-target', 'l8-review', 'l9-target', 'l9-review',
                'l11-target', 'l11-review', 'l12-target', 'l12-review', 'l14-review-part67'
            ];

            if (!noShuffleLessons.includes(currentMode)) {
                shuffleArray(sourcePool);
            }
            
            currentQuestions = sourcePool.slice(0, questionCount);

            if(currentQuestions.length > 0) {
                switchScreen(quizScreen);
                loadQuestion();
            } else if (currentMode !== 'incorrect' && !isLessonMode) {
                showModal('問題エラー', '選択されたモードの問題が見つかりませんでした。');
            } else if (isLessonMode && sourcePool.length === 0) {
                    // This case is handled by the mastery check at the beginning
            }
        }

        function loadQuestion() {
            if (currentQuestions.length === 0 || currentQuestionIndex >= currentQuestions.length) {
                showQuizResult();
                return;
            }
            const question = currentQuestions[currentQuestionIndex];

            // Handle long text display and highlighting
            if (question.longText) {
                let textToShow = question.longText.replace(/\n/g, '<br>');
                if(question.highlightText) {
                    textToShow = textToShow.replace(question.highlightText, `<span class="highlight">${question.highlightText}</span>`);
                }
                longTextArea.innerHTML = textToShow;
                longTextArea.style.display = 'block';
            } else {
                longTextArea.style.display = 'none';
            }

            questionTextElement.innerHTML = question.text;
            optionsGridElement.innerHTML = '';
            feedbackMessageElement.style.display = 'none';
            feedbackMessageElement.classList.remove('correct-feedback', 'incorrect-feedback');
            explanationContentElement.classList.remove('show');
            explanationTextElement.textContent = '';
            toggleExplanationButton.classList.add('hidden');
            toggleExplanationButton.textContent = '解説▼';

            const shuffledOptions = [...question.options];
            // Do not shuffle options for long text questions to maintain consistency (A, B, C, D)
            const noShuffleLessons = [
                'l2-target', 'l2-review', 'l3-target', 'l3-review', 'l5-target', 'l5-review',
                'l6-target', 'l6-review', 'l8-target', 'l8-review', 'l9-target', 'l9-review',
                'l11-target', 'l11-review', 'l12-target', 'l12-review', 'l14-review-part67'
            ];
            if (!noShuffleLessons.includes(currentMode)) {
                shuffleArray(shuffledOptions);
            }
            
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = option;
                button.classList.add('option-button');
                button.dataset.option = option;
                button.addEventListener('click', () => selectOption(option, question.answer, question.id));
                optionsGridElement.appendChild(button);
            });
            updateProgressBar();
            updateNavigationButtons();
        }

        function selectOption(selectedOption, correctAnswer, questionId) {
            if (answeredQuestions.has(questionId)) return;
            disableOptions();
            const currentQuestion = currentQuestions[currentQuestionIndex];
            feedbackMessageElement.style.display = 'block';

            if (selectedOption === correctAnswer) {
                playSound('correct');
                feedbackResultElement.innerHTML = `<strong>正解！</strong>`;
                feedbackMessageElement.classList.add('correct-feedback');
                score++;

                consecutiveCorrectCounts[questionId] = (consecutiveCorrectCounts[questionId] || 0) + 1;
                
                const isLessonMode = currentMode !== 'random' && currentMode !== 'incorrect';
                if (isLessonMode) {
                    const requiredCorrects = masteryMode ? 2 : 1;
                    if (consecutiveCorrectCounts[questionId] >= requiredCorrects) {
                        if (!correctlyAnsweredByLesson[currentMode]) {
                            correctlyAnsweredByLesson[currentMode] = [];
                        }
                        if (!correctlyAnsweredByLesson[currentMode].includes(questionId)) {
                            correctlyAnsweredByLesson[currentMode].push(questionId);
                        }
                    }
                }
                
                if (masteryMode) {
                    if (consecutiveCorrectCounts[questionId] >= 2) {
                        incorrectQuestionIds = incorrectQuestionIds.filter(id => id !== questionId);
                    }
                } else {
                    incorrectQuestionIds = incorrectQuestionIds.filter(id => id !== questionId);
                }

            } else {
                playSound('incorrect');
                feedbackResultElement.innerHTML = `<strong>不正解...</strong> 正解は「${correctAnswer}」でした。`;
                feedbackMessageElement.classList.add('incorrect-feedback');
                if (!incorrectQuestionIds.includes(questionId)) incorrectQuestionIds.push(questionId);
                if (!sessionIncorrectQuestionIds.includes(questionId)) sessionIncorrectQuestionIds.push(questionId);
                consecutiveCorrectCounts[questionId] = 0;
            }
            
            answeredQuestions.add(questionId);
            localStorage.setItem(APP_PREFIX + 'incorrectQuestions', JSON.stringify(incorrectQuestionIds));
            localStorage.setItem(APP_PREFIX + 'correctlyAnsweredByLesson', JSON.stringify(correctlyAnsweredByLesson));
            localStorage.setItem(APP_PREFIX + 'consecutiveCorrectCounts', JSON.stringify(consecutiveCorrectCounts));


            optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                if (button.dataset.option === correctAnswer) button.classList.add('correct');
                else if (button.dataset.option === selectedOption) button.classList.add('incorrect');
            });

            // ここが重要: currentQuestion.explanation が存在する場合のみボタンを表示
            if (currentQuestion.explanation) {
                explanationTextElement.textContent = currentQuestion.explanation;
                toggleExplanationButton.classList.remove('hidden');
            } else {
                // 解説がない場合はボタンを隠すことを確認
                toggleExplanationButton.classList.add('hidden');
                explanationContentElement.classList.remove('show'); // 解説表示も閉じる
            }
            updateNavigationButtons();
        }

        function disableOptions() {
            optionsGridElement.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
                button.style.cursor = 'default';
            });
        }

        function updateNavigationButtons() {
            const currentQuestion = currentQuestions[currentQuestionIndex];
            if (!currentQuestion) {
                nextButton.disabled = true;
                return;
            }
            nextButton.disabled = !answeredQuestions.has(currentQuestion.id);
            nextButton.textContent = (currentQuestionIndex === currentQuestions.length - 1 && !nextButton.disabled) ? '結果を見る' : '次の問題';
        }

        function updateProgressBar() {
            const show = showProgress && currentQuestions.length > 0;
            progressBarContainer.style.display = show ? 'block' : 'none';
            progressText.style.display = show ? 'block' : 'none';
            if (!show) return;
            
            const total = currentQuestions.length;
            const progress = total > 0 ? (currentQuestionIndex + 1) / total : 0;
            progressBar.style.width = `${progress * 100}%`;
            progressText.textContent = `${currentQuestionIndex + 1} / ${total} 問目`;
        }

        function launchConfetti() {
            if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
            confettiContainer.innerHTML = '';
            const confettiPieces = [];
            const numConfetti = 100;
            const colors = ['#f43f5e', '#38bdf8', '#fbbf24', '#34d399', '#8b5cf6'];

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[i % colors.length];
                confettiContainer.appendChild(confetti);
                
                const piece = {
                    element: confetti,
                    x: confettiContainer.clientWidth / 2,
                    y: confettiContainer.clientHeight,
                    vx: (Math.random() - 0.5) * 10,
                    vy: -Math.random() * 15 - 5, // Initial upward velocity
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 20,
                    opacity: 1
                };
                confettiPieces.push(piece);
            }

            let startTime = null;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;

                let allOffScreen = true;
                confettiPieces.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.2; // Gravity
                    p.vx *= 0.99; // Air resistance
                    p.rotation += p.rotationSpeed;
                    
                    if (p.y < confettiContainer.clientHeight + 20) { // Give some buffer
                        allOffScreen = false;
                    }

                    p.element.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rotation}deg)`;
                });

                if (allOffScreen && progress > 1000) { // Ensure it runs for at least a second
                    confettiContainer.innerHTML = '';
                    cancelAnimationFrame(confettiAnimationId);
                    confettiAnimationId = null;
                } else {
                    confettiAnimationId = requestAnimationFrame(animate);
                }
            }
            confettiAnimationId = requestAnimationFrame(animate);
        }


        function showQuizResult() {
            switchScreen(resultScreen);
            updateLessonDropdown();
            const total = currentQuestions.length;
            finalScore.textContent = `あなたのスコア: ${score} / ${total}`;

            const percentage = total === 0 ? 0 : (score / total) * 100;
            let comment = '';
            if (score === total && total > 0) {
                comment = '素晴らしい！全問正解です！🎉';
                playSound('fanfare');
                setTimeout(launchConfetti, 100); // Delay to ensure rendering
            } else if (percentage >= 80) {
                comment = 'よくできました！この調子で頑張りましょう！✨';
            } else if (percentage >= 50) {
                comment = 'もう少しです！復習して、さらに上を目指しましょう！👍';
            } else {
                comment = '頑張ろう！基礎をしっかり固めていきましょう！💪';
            }
            scoreComment.textContent = comment;
            redoIncorrectButton.style.display = sessionIncorrectQuestionIds.length > 0 ? 'block' : 'none';
        }
        
        function updateLessonDropdown() {
            const lessonOptions = document.querySelectorAll('#quizModeSelect optgroup option');
            lessonOptions.forEach(option => {
                const lessonId = option.value;
                const allLessonQuestions = allQuestions.filter(q => q.lesson === lessonId);
                const correctlyAnsweredIds = correctlyAnsweredByLesson[lessonId] || [];
                
                option.textContent = option.textContent.replace('✅ ', '');

                if (allLessonQuestions.length > 0 && correctlyAnsweredIds.length >= allLessonQuestions.length) {
                    option.textContent = '✅ ' + option.textContent;
                }
            });
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', prepareQuiz);
        nextButton.addEventListener('click', () => {
            playSound('click');
            currentQuestionIndex++;
            loadQuestion();
        });
        settingsButton.addEventListener('click', () => switchScreen(settingsScreen));
        backToStartButton.addEventListener('click', () => switchScreen(startScreen));
        interruptButton.addEventListener('click', () => {
            showModal('クイズ中断', 'クイズを中断しますか？現在の進捗は失われます。', () => {
                switchScreen(startScreen);
            });
        });
        restartButton.addEventListener('click', () => {
            playSound('click');
            switchScreen(startScreen);
            if (confettiAnimationId) {
                cancelAnimationFrame(confettiAnimationId);
                confettiContainer.innerHTML = '';
            }
        });
        redoIncorrectButton.addEventListener('click', () => {
            playSound('click');
            if (sessionIncorrectQuestionIds.length === 0) return;
            currentQuestions = allQuestions.filter(q => sessionIncorrectQuestionIds.includes(q.id));
            shuffleArray(currentQuestions);
            currentQuestionIndex = 0;
            score = 0;
            answeredQuestions.clear();
            sessionIncorrectQuestionIds = [];
            switchScreen(quizScreen);
            loadQuestion();
        });
        toggleExplanationButton.addEventListener('click', () => {
            explanationContentElement.classList.toggle('show');
            toggleExplanationButton.textContent = explanationContentElement.classList.contains('show') ? '解説▲' : '解説▼';
        });
        darkModeToggle.addEventListener('change', (e) => setDarkMode(e.target.checked));
        themeColorCircles.forEach(circle => {
            circle.addEventListener('click', () => {
                themeColorCircles.forEach(c => c.classList.remove('selected'));
                circle.classList.add('selected');
                setThemeColor(circle.dataset.theme);
            });
        });
        questionCountSelect.addEventListener('change', (e) => localStorage.setItem(APP_PREFIX + 'questionCount', e.target.value));
        showProgressToggle.addEventListener('change', (e) => {
            showProgress = e.target.checked;
            localStorage.setItem(APP_PREFIX + 'showProgress', String(showProgress));
            updateProgressBar();
        });
        enableSoundToggle.addEventListener('change', (e) => {
            enableSound = e.target.checked;
            localStorage.setItem(APP_PREFIX + 'enableSound', String(enableSound));
        });
        masteryModeToggle.addEventListener('change', (e) => {
            masteryMode = e.target.checked;
            localStorage.setItem(APP_PREFIX + 'masteryMode', String(masteryMode));
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem(APP_PREFIX + 'darkMode') === 'true';
            document.body.classList.toggle('dark-mode', isDark);
            darkModeToggle.checked = isDark;
            
            const savedTheme = localStorage.getItem(APP_PREFIX + 'themeColor') || 'default';
            document.querySelector(`.color-circle[data-theme="${savedTheme}"]`)?.classList.add('selected');
            
            applyColors(savedTheme, isDark);

            const storedIncorrect = localStorage.getItem(APP_PREFIX + 'incorrectQuestions');
            if (storedIncorrect) {
                try { incorrectQuestionIds = JSON.parse(storedIncorrect); } catch { incorrectQuestionIds = []; }
            }
            const storedCorrect = localStorage.getItem(APP_PREFIX + 'correctlyAnsweredByLesson');
            if (storedCorrect) {
                try { correctlyAnsweredByLesson = JSON.parse(storedCorrect); } catch { correctlyAnsweredByLesson = {}; }
            }
            const storedConsecutive = localStorage.getItem(APP_PREFIX + 'consecutiveCorrectCounts');
            if (storedConsecutive) {
                try { consecutiveCorrectCounts = JSON.parse(storedConsecutive); } catch { consecutiveCorrectCounts = {}; }
            }

            quizModeSelect.value = localStorage.getItem(APP_PREFIX + 'lastSelectedMode') || 'random';
            questionCountSelect.value = localStorage.getItem(APP_PREFIX + 'questionCount') || '10';
            showProgress = localStorage.getItem(APP_PREFIX + 'showProgress') !== 'false';
            showProgressToggle.checked = showProgress;
            enableSound = localStorage.getItem(APP_PREFIX + 'enableSound') !== 'false';
            enableSoundToggle.checked = enableSound;
            masteryMode = localStorage.getItem(APP_PREFIX + 'masteryMode') === 'true';
            masteryModeToggle.checked = masteryMode;

            updateLessonDropdown();
            switchScreen(startScreen);
        });
    </script>
</body>
</html>
